name: Daily Titan Content (Working)

on:
  schedule:
    - cron: '0 10 * * *'
  workflow_dispatch:

jobs:
  generate-content:
    name: Generate Blog Content
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements_titan.txt
          echo "Dependencies installed"
      
      - name: Configure environment
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          cat > .env << EOF
          GEMINI_API_KEY=${GEMINI_API_KEY}
          TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
          TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
          EOF
      
      - name: Generate article
        id: generate
        run: |
          python3 -c "
          import os
          import sys
          import json
          
          sys.path.insert(0, '.')
          
          from titan_modules.blog.intelligence.topic_generator import TopicGenerator
          from titan_modules.blog.writer.article_generator import ArticleGenerator
          
          # Generate topic
          print('Generating topic...')
          topic_gen = TopicGenerator()
          brief = topic_gen.generate_next_topic()
          
          print(f'Topic: {brief[\"primary_keyword\"]}')
          print(f'Category: {brief[\"category\"]}')
          
          # Generate article
          print('Writing article...')
          article_gen = ArticleGenerator(os.getenv('GEMINI_API_KEY'))
          article = article_gen.write_article(brief)
          
          print(f'Complete: {article[\"word_count\"]} words')
          
          # Save HTML
          html = '''<!DOCTYPE html>
          <html lang=\"en\">
          <head>
              <meta charset=\"UTF-8\">
              <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
              <title>''' + article['title'] + '''</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: system-ui, sans-serif;
                      max-width: 900px;
                      margin: 0 auto;
                      padding: 20px;
                      background: #FAFAFA;
                      color: #2C3E50;
                      line-height: 1.7;
                  }
                  .header {
                      background: linear-gradient(135deg, #FF6B35 0%, #FF8C61 100%);
                      color: white;
                      padding: 40px;
                      border-radius: 15px;
                      margin-bottom: 40px;
                      text-align: center;
                      box-shadow: 0 10px 30px rgba(255, 107, 53, 0.3);
                  }
                  .logo {
                      font-size: 3em;
                      font-weight: bold;
                      margin-bottom: 10px;
                  }
                  .tagline {
                      font-size: 1.2em;
                      opacity: 0.95;
                  }
                  .article {
                      background: white;
                      padding: 50px;
                      border-radius: 15px;
                      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
                  }
                  h1 {
                      color: #FF6B35;
                      font-size: 2.5em;
                      margin-bottom: 0.5em;
                  }
                  h2 {
                      color: #004E89;
                      margin-top: 2em;
                      font-size: 1.8em;
                      border-bottom: 3px solid #FF6B35;
                      padding-bottom: 10px;
                  }
                  h3 {
                      color: #1A659E;
                      margin-top: 1.5em;
                      font-size: 1.4em;
                  }
                  p {
                      margin: 1.2em 0;
                      font-size: 1.1em;
                  }
                  .cta {
                      background: linear-gradient(135deg, #004E89 0%, #1A659E 100%);
                      color: white;
                      padding: 40px;
                      border-radius: 15px;
                      margin-top: 50px;
                      text-align: center;
                  }
                  .cta h3 { color: white; font-size: 2em; margin-bottom: 20px; }
                  .cta-button {
                      display: inline-block;
                      background: #FF6B35;
                      color: white;
                      padding: 15px 40px;
                      border-radius: 30px;
                      text-decoration: none;
                      font-weight: bold;
                      margin-top: 20px;
                  }
                  .footer {
                      text-align: center;
                      padding: 40px;
                      color: #666;
                      margin-top: 50px;
                  }
                  @media (max-width: 768px) {
                      body { padding: 10px; }
                      .header, .article { padding: 30px 20px; }
                      h1 { font-size: 1.8em; }
                  }
              </style>
          </head>
          <body>
              <div class=\"header\">
                  <div class=\"logo\">üéÅ SayPlay</div>
                  <div class=\"tagline\">Voice Message Gifts That Last Forever</div>
              </div>
              <div class=\"article\">
                  <h1>''' + article['title'] + '''</h1>
                  ''' + article['html'] + '''
              </div>
              <div class=\"cta\">
                  <h3>Create Your Own Voice Message Gift</h3>
                  <p>Turn your words into unforgettable memories</p>
                  <a href=\"https://sayplay.co.uk\" class=\"cta-button\">Shop Now</a>
              </div>
              <div class=\"footer\">
                  <p><strong>SayPlay | Just Tap - No App Needed</strong></p>
                  <p>üåê <a href=\"https://sayplay.co.uk\" style=\"color:#FF6B35\">SayPlay.co.uk</a></p>
              </div>
          </body>
          </html>'''
          
          with open('test_article.html', 'w', encoding='utf-8') as f:
              f.write(html)
          
          # Save metadata
          meta = {
              'title': article['title'],
              'keyword': brief['primary_keyword'],
              'category': brief['category'],
              'words': article['word_count']
          }
          
          with open('article_meta.json', 'w') as f:
              json.dump(meta, f)
          
          # Output for GitHub
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f\"title={article['title']}\n\")
              f.write(f\"keyword={brief['primary_keyword']}\n\")
              f.write(f\"category={brief['category']}\n\")
              f.write(f\"words={article['word_count']}\n\")
          "
      
      - name: Commit database
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [ -f "titan_modules/blog/intelligence/topics_database.json" ]; then
            git add titan_modules/blog/intelligence/topics_database.json
            git diff --staged --quiet || git commit -m "Update topics [skip ci]"
            git push || echo "Nothing to push"
          fi
      
      - name: Upload article
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: blog-article-${{ github.run_number }}
          path: |
            test_article.html
            article_meta.json
          retention-days: 30
      
      - name: Send to Telegram
        if: success()
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          TITLE="${{ steps.generate.outputs.title }}"
          KEYWORD="${{ steps.generate.outputs.keyword }}"
          CATEGORY="${{ steps.generate.outputs.category }}"
          WORDS="${{ steps.generate.outputs.words }}"
          URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          TEXT="üéÅ SayPlay Content Generated!
          
          üì∞ ${TITLE}
          
          üéØ Keyword: ${KEYWORD}
          üìÅ Category: ${CATEGORY}
          üìä Words: ${WORDS}
          
          ‚¨áÔ∏è Download: ${URL}
          
          ü§ñ Perpetual content - never repeats!"
          
          TEXT_ENCODED=$(echo "$TEXT" | jq -sRr @uri)
          
          curl -s -X POST \
            "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d "chat_id=${CHAT_ID}" \
            -d "text=${TEXT_ENCODED}"
      
      - name: Notify failure
        if: failure()
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TEXT="‚ö†Ô∏è Titan workflow failed! Check: ${URL}"
          TEXT_ENCODED=$(echo "$TEXT" | jq -sRr @uri)
          
          curl -s -X POST \
            "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d "chat_id=${CHAT_ID}" \
            -d "text=${TEXT_ENCODED}"
