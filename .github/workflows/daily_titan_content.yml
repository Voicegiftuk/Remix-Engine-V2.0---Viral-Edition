name: Daily Titan Content Enhanced
on:
  schedule:
    - cron: '0 10 * * *'
  workflow_dispatch:

jobs:
  titan-enhanced:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements_titan.txt
      
      - name: Run Titan System
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          PINTEREST_ACCESS_TOKEN: ${{ secrets.PINTEREST_ACCESS_TOKEN }}
          PINTEREST_BOARD_ID: ${{ secrets.PINTEREST_BOARD_ID }}
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
        run: python titan_master_orchestrator_zero_cost.py
      
      - name: Upload generated content
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titan-content-${{ github.run_number }}
          path: |
            article.html
            article.txt
            article_meta.json
            podcast.mp3
            translations/
            images/
            seo_pages_summary.json
            b2b_validation_log.json
            influencer_scout_db.json
          retention-days: 30
          if-no-files-found: warn
      
      - name: Commit updates
        if: success()
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add -A
          git diff --staged --quiet || git commit -m "Update [skip ci]"
          git push || true
      
      - name: Success notification
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=HTML" \
            -d "disable_web_page_preview=false" \
            -d "text=üéâ <b>Titan Complete - Run #${{ github.run_number }}</b>%0A%0Aüì• <b>DOWNLOAD FILES:</b>%0A%0A<a href='https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'>üëâ Click here to open workflow run</a>%0A%0A<b>Then:</b>%0A1Ô∏è‚É£ Scroll to bottom of page%0A2Ô∏è‚É£ Find section <b>Artifacts</b>%0A3Ô∏è‚É£ Click <b>titan-content-${{ github.run_number }}</b>%0A4Ô∏è‚É£ Download ZIP file!%0A%0A‚úÖ All your content is ready inside"
      
      - name: Failure notification
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=HTML" \
            -d "text=‚ùå <b>Titan Failed - Run #${{ github.run_number }}</b>%0A%0A<a href='https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'>üëâ Click to view error logs</a>%0A%0ACheck the logs to see what went wrong."
