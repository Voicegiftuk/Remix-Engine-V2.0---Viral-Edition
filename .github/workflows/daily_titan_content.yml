name: Daily Titan Content (Intelligent + Perpetual + Branded)

on:
  schedule:
    - cron: '0 10 * * *'  # Daily at 10 AM UTC
  
  workflow_dispatch:
    inputs:
      force_category:
        description: 'Force specific category (optional)'
        required: false
        type: choice
        options:
          - 'auto'
          - 'birthday'
          - 'wedding'
          - 'anniversary'
          - 'christmas'
          - 'mothers day'
          - 'fathers day'

jobs:
  generate-intelligent-content:
    name: Generate Intelligent Blog Article
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      # ============================================
      # SETUP
      # ============================================
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # ============================================
      # DEPENDENCIES
      # ============================================
      
      - name: Install Titan dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements_titan.txt
          echo "‚úì Dependencies installed"
      
      # ============================================
      # CONFIGURATION
      # ============================================
      
      - name: Configure environment
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PINTEREST_TOKEN: ${{ secrets.PINTEREST_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          cat > .env << EOF
          GEMINI_API_KEY=${GEMINI_API_KEY}
          PINTEREST_TOKEN=${PINTEREST_TOKEN}
          TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
          TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
          EOF
          echo "‚úì Environment configured"
      
      # ============================================
      # INTELLIGENT CONTENT GENERATION WITH BRANDING
      # ============================================
      
      - name: Generate branded blog article
        id: blog
        run: |
          echo "üß† Generating intelligent branded content..."
          
          python << 'PYTHON_SCRIPT'
          import os
          import json
          import base64
          from pathlib import Path
          from titan_modules.blog.intelligence.topic_generator import TopicGenerator
          from titan_modules.blog.writer.article_generator import ArticleGenerator
          
          # Load SayPlay logo
          logo_path = Path('assets/brand/sayplay_logo.png')
          if logo_path.exists():
              with open(logo_path, 'rb') as f:
                  logo_bytes = f.read()
                  logo_base64 = base64.b64encode(logo_bytes).decode('utf-8')
              logo_html = f'<img src="data:image/png;base64,{logo_base64}" alt="SayPlay Logo" style="max-height: 80px; margin-bottom: 20px;">'
              print("‚úì Logo loaded: assets/brand/sayplay_logo.png")
          else:
              logo_html = '<div class="logo">üéÅ SayPlay</div>'
              print("‚ö†Ô∏è  Logo not found, using emoji fallback")
          
          # Generate smart topic
          print("\nüéØ Generating unique topic...")
          topic_gen = TopicGenerator()
          brief = topic_gen.generate_next_topic()
          
          print(f"\nüìù Topic selected: {brief['primary_keyword']}")
          print(f"   Category: {brief['category']}")
          print(f"   Trending score: {brief['trending_score']}/100")
          
          # Generate article
          print(f"\n‚úçÔ∏è  Writing article...")
          article_gen = ArticleGenerator(os.getenv('GEMINI_API_KEY'))
          article = article_gen.write_article(brief)
          
          print(f"\n‚úÖ Article complete!")
          print(f"   Words: {article['word_count']}")
          print(f"   Sections: {len(article['outline'])}")
          
          # Create fully branded HTML
          html_content = f"""<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <meta name="description" content="{article['meta_description']}">
              <meta name="keywords" content="{', '.join(brief['related_keywords'][:5])}">
              <meta property="og:title" content="{article['title']}">
              <meta property="og:description" content="{article['meta_description']}">
              <meta property="og:url" content="https://sayplay.co.uk">
              <title>{article['title']}</title>
              <style>
                  * {{
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }}
                  
                  body {{
                      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
                      max-width: 900px;
                      margin: 0 auto;
                      padding: 20px;
                      line-height: 1.7;
                      color: #2C3E50;
                      background: #FAFAFA;
                  }}
                  
                  /* SAYPLAY BRANDED HEADER */
                  .header {{
                      background: linear-gradient(135deg, #FF6B35 0%, #FF8C61 100%);
                      color: white;
                      padding: 40px;
                      border-radius: 15px;
                      margin-bottom: 40px;
                      text-align: center;
                      box-shadow: 0 10px 30px rgba(255, 107, 53, 0.3);
                  }}
                  
                  .logo {{
                      font-size: 3em;
                      font-weight: bold;
                      margin-bottom: 10px;
                      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
                  }}
                  
                  .tagline {{
                      font-size: 1.2em;
                      opacity: 0.95;
                      font-weight: 300;
                      letter-spacing: 0.5px;
                  }}
                  
                  /* ARTICLE CONTAINER */
                  .article {{
                      background: white;
                      padding: 50px;
                      border-radius: 15px;
                      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
                  }}
                  
                  /* METADATA BAR */
                  .meta {{
                      display: flex;
                      gap: 20px;
                      flex-wrap: wrap;
                      padding: 20px;
                      background: #F8F9FA;
                      border-left: 4px solid #FF6B35;
                      border-radius: 8px;
                      margin-bottom: 30px;
                      font-size: 0.9em;
                      color: #666;
                  }}
                  
                  .meta-item {{
                      display: flex;
                      align-items: center;
                      gap: 5px;
                  }}
                  
                  .meta-label {{
                      font-weight: 600;
                      color: #FF6B35;
                  }}
                  
                  /* TYPOGRAPHY */
                  h1 {{
                      color: #FF6B35;
                      font-size: 2.5em;
                      margin-bottom: 0.5em;
                      line-height: 1.2;
                      font-weight: 700;
                  }}
                  
                  h2 {{
                      color: #004E89;
                      margin-top: 2em;
                      margin-bottom: 0.8em;
                      font-size: 1.8em;
                      border-bottom: 3px solid #FF6B35;
                      padding-bottom: 10px;
                      font-weight: 600;
                  }}
                  
                  h3 {{
                      color: #1A659E;
                      margin-top: 1.5em;
                      margin-bottom: 0.6em;
                      font-size: 1.4em;
                      font-weight: 600;
                  }}
                  
                  p {{
                      margin: 1.2em 0;
                      font-size: 1.1em;
                      line-height: 1.8;
                  }}
                  
                  strong {{
                      color: #FF6B35;
                      font-weight: 600;
                  }}
                  
                  em {{
                      color: #004E89;
                      font-style: italic;
                  }}
                  
                  /* CALL TO ACTION */
                  .cta {{
                      background: linear-gradient(135deg, #004E89 0%, #1A659E 100%);
                      color: white;
                      padding: 40px;
                      border-radius: 15px;
                      margin-top: 50px;
                      text-align: center;
                      box-shadow: 0 5px 20px rgba(0, 78, 137, 0.3);
                  }}
                  
                  .cta h3 {{
                      color: white;
                      margin-top: 0;
                      font-size: 2em;
                      border: none;
                      padding: 0;
                  }}
                  
                  .cta p {{
                      font-size: 1.2em;
                      margin: 20px 0;
                      opacity: 0.95;
                  }}
                  
                  .cta-button {{
                      display: inline-block;
                      background: #FF6B35;
                      color: white;
                      padding: 15px 40px;
                      border-radius: 30px;
                      text-decoration: none;
                      font-weight: bold;
                      font-size: 1.1em;
                      margin-top: 20px;
                      transition: all 0.3s ease;
                      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
                  }}
                  
                  .cta-button:hover {{
                      transform: translateY(-2px);
                      box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
                  }}
                  
                  /* FOOTER */
                  .footer {{
                      text-align: center;
                      padding: 40px 20px;
                      color: #666;
                      font-size: 0.9em;
                      margin-top: 50px;
                      border-top: 2px solid #E0E0E0;
                  }}
                  
                  .footer-logo {{
                      color: #FF6B35;
                      font-weight: bold;
                      font-size: 1.5em;
                      margin-bottom: 10px;
                  }}
                  
                  .footer a {{
                      color: #FF6B35;
                      text-decoration: none;
                  }}
                  
                  .footer a:hover {{
                      text-decoration: underline;
                  }}
                  
                  /* RESPONSIVE */
                  @media (max-width: 768px) {{
                      body {{
                          padding: 10px;
                      }}
                      
                      .header {{
                          padding: 30px 20px;
                      }}
                      
                      .article {{
                          padding: 30px 20px;
                      }}
                      
                      .logo {{
                          font-size: 2em;
                      }}
                      
                      h1 {{
                          font-size: 1.8em;
                      }}
                      
                      h2 {{
                          font-size: 1.4em;
                      }}
                      
                      .meta {{
                          flex-direction: column;
                          gap: 10px;
                      }}
                  }}
              </style>
          </head>
          <body>
              <!-- SAYPLAY BRANDED HEADER -->
              <div class="header">
                  {logo_html}
                  <div class="tagline">Voice Message Gifts That Last Forever</div>
              </div>
              
              <!-- ARTICLE CONTENT -->
              <div class="article">
                  <div class="meta">
                      <div class="meta-item">
                          <span class="meta-label">üìÅ Category:</span>
                          <span>{brief['category'].title()}</span>
                      </div>
                      <div class="meta-item">
                          <span class="meta-label">üìä Words:</span>
                          <span>{article['word_count']}</span>
                      </div>
                      <div class="meta-item">
                          <span class="meta-label">üî• Trending:</span>
                          <span>{brief['trending_score']}/100</span>
                      </div>
                  </div>
                  
                  <h1>{article['title']}</h1>
                  
                  {article['html']}
              </div>
              
              <!-- CALL TO ACTION -->
              <div class="cta">
                  <h3>üéÅ Create Your Own Voice Message Gift</h3>
                  <p>Turn your words into unforgettable memories with SayPlay's personalized voice message gifts.</p>
                  <p><strong>Just Tap - No App Needed</strong></p>
                  <a href="https://sayplay.co.uk" class="cta-button">Shop Now ‚Üí</a>
              </div>
              
              <!-- FOOTER -->
              <div class="footer">
                  <div class="footer-logo">üéÅ SayPlay</div>
                  <p><strong>Voice Message Gifts | Just Tap - No App Needed</strong></p>
                  <p>üìç UK | üåê <a href="https://sayplay.co.uk">SayPlay.co.uk</a></p>
                  <p style="margin-top: 20px; font-size: 0.85em; opacity: 0.8;">
                      Generated by Titan Content Engine | ¬© 2025 SayPlay
                  </p>
              </div>
          </body>
          </html>"""
          
          # Save article
          with open('test_article.html', 'w', encoding='utf-8') as f:
              f.write(html_content)
          
          # Save metadata
          metadata = {
              'title': article['title'],
              'keyword': brief['primary_keyword'],
              'category': brief['category'],
              'words': article['word_count'],
              'trending': brief['trending_score'],
              'related_keywords': brief['related_keywords'][:5],
              'has_logo': logo_path.exists()
          }
          
          with open('article_meta.json', 'w') as f:
              json.dump(metadata, f, indent=2)
          
          # GitHub Actions output
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"article_title={article['title']}\n")
              f.write(f"article_keyword={brief['primary_keyword']}\n")
              f.write(f"article_category={brief['category']}\n")
              f.write(f"article_words={article['word_count']}\n")
              f.write(f"trending_score={brief['trending_score']}\n")
          
          print(f"\nüíæ Article saved with full SayPlay branding!")
          print(f"   Logo: {'‚úÖ Embedded' if logo_path.exists() else '‚ö†Ô∏è  Emoji fallback'}")
          print(f"   File: test_article.html")
          
          PYTHON_SCRIPT
          
          echo "‚úÖ Branded content generation complete"
      
      # ============================================
      # PERSIST TOPIC DATABASE
      # ============================================
      
      - name: Commit topic database
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [ -f "titan_modules/blog/intelligence/topics_database.json" ]; then
            git add titan_modules/blog/intelligence/topics_database.json
            git diff --staged --quiet || git commit -m "Update topics database [skip ci]"
            git push
            echo "‚úÖ Topics database updated"
          else
            echo "‚ö†Ô∏è  No database to commit yet"
          fi
      
      # ============================================
      # ARTIFACT STORAGE
      # ============================================
      
      - name: Upload blog article
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: blog-article-${{ github.run_number }}
          path: |
            test_article.html
            article_meta.json
          retention-days: 30
      
      # ============================================
      # TELEGRAM NOTIFICATION
      # ============================================
      
      - name: Send to Telegram
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          TITLE="${{ steps.blog.outputs.article_title }}"
          KEYWORD="${{ steps.blog.outputs.article_keyword }}"
          CATEGORY="${{ steps.blog.outputs.article_category }}"
          WORDS="${{ steps.blog.outputs.article_words }}"
          TRENDING="${{ steps.blog.outputs.trending_score }}"
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          MESSAGE="üéÅ <b>SayPlay Content Generated!</b>%0A%0A"
          MESSAGE="${MESSAGE}üì∞ ${TITLE}%0A%0A"
          MESSAGE="${MESSAGE}üéØ Keyword: <code>${KEYWORD}</code>%0A"
          MESSAGE="${MESSAGE}üìÅ Category: ${CATEGORY}%0A"
          MESSAGE="${MESSAGE}üìä Words: ${WORDS}%0A"
          MESSAGE="${MESSAGE}üî• Trending: ${TRENDING}/100%0A%0A"
          MESSAGE="${MESSAGE}‚¨áÔ∏è <a href='${DOWNLOAD_URL}'>Download Branded Article</a>%0A%0A"
          MESSAGE="${MESSAGE}‚ú® <b>Features:</b>%0A"
          MESSAGE="${MESSAGE}‚Ä¢ SayPlay logo embedded%0A"
          MESSAGE="${MESSAGE}‚Ä¢ Brand colors applied%0A"
          MESSAGE="${MESSAGE}‚Ä¢ Call-to-action included%0A"
          MESSAGE="${MESSAGE}‚Ä¢ Mobile responsive%0A%0A"
          MESSAGE="${MESSAGE}üí° <b>Next:</b> Create Pinterest pin%0A"
          MESSAGE="${MESSAGE}ü§ñ <i>Perpetual content - never repeats!</i>"
          
          curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="HTML" \
            -d text="${MESSAGE}"
          
          echo "‚úÖ Notification sent to Telegram"

  # ============================================
  # PINTEREST CONNECTION TEST
  # ============================================

  test-pinterest:
    name: Test Pinterest Connection
    runs-on: ubuntu-latest
    needs: generate-intelligent-content
    if: success()
    timeout-minutes: 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements_titan.txt
      
      - name: Configure environment
        env:
          PINTEREST_TOKEN: ${{ secrets.PINTEREST_TOKEN }}
        run: |
          cat > .env << EOF
          PINTEREST_TOKEN=${PINTEREST_TOKEN}
          EOF
      
      - name: Test Pinterest API
        id: pinterest
        run: |
          echo "üìå Testing Pinterest connection..."
          python titan_modules/distribution/publishers/pinterest_publisher.py
          echo "pinterest_status=ready" >> $GITHUB_OUTPUT
      
      - name: Notify Pinterest status
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="üìå <b>Pinterest Status: READY</b>%0A%0A"
          MESSAGE="${MESSAGE}‚úÖ API connection verified%0A"
          MESSAGE="${MESSAGE}‚úÖ Ready to create pins%0A%0A"
          MESSAGE="${MESSAGE}üì∏ <b>Pin Creation Checklist:</b>%0A"
          MESSAGE="${MESSAGE}1Ô∏è‚É£ Product photo (1000x1500px)%0A"
          MESSAGE="${MESSAGE}2Ô∏è‚É£ Add SayPlay logo watermark%0A"
          MESSAGE="${MESSAGE}3Ô∏è‚É£ Use brand colors (#FF6B35)%0A"
          MESSAGE="${MESSAGE}4Ô∏è‚É£ Copy article title%0A"
          MESSAGE="${MESSAGE}5Ô∏è‚É£ Link to SayPlay.co.uk%0A%0A"
          MESSAGE="${MESSAGE}üé® <b>Brand Assets:</b>%0A"
          MESSAGE="${MESSAGE}‚Ä¢ Logo: assets/brand/sayplay_logo.png%0A"
          MESSAGE="${MESSAGE}‚Ä¢ Orange: #FF6B35%0A"
          MESSAGE="${MESSAGE}‚Ä¢ Blue: #004E89"
          
          curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="HTML" \
            -d text="${MESSAGE}"

  # ============================================
  # CONTENT STATISTICS
  # ============================================

  show-stats:
    name: Show Content Statistics
    runs-on: ubuntu-latest
    needs: generate-intelligent-content
    if: success()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Display statistics
        run: |
          python << 'PYTHON_SCRIPT'
          import json
          from pathlib import Path
          
          db_file = Path('titan_modules/blog/intelligence/topics_database.json')
          
          if db_file.exists():
              with open(db_file, 'r') as f:
                  db = json.load(f)
              
              print("\n" + "=" * 60)
              print("üìä TITAN CONTENT ENGINE - STATISTICS")
              print("=" * 60)
              print(f"\nüìà Total Articles: {db['stats']['total_generated']}")
              print(f"\nüìÅ By Category:")
              for cat, count in sorted(db['stats']['by_category'].items(), 
                                       key=lambda x: x[1], reverse=True):
                  print(f"   {cat.title()}: {count}")
              print("\n" + "=" * 60)
          else:
              print("\nüìä First article - statistics will build over time!")
          
          PYTHON_SCRIPT

  # ============================================
  # FAILURE NOTIFICATION
  # ============================================

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [generate-intelligent-content, test-pinterest]
    if: failure()
    
    steps:
      - name: Send failure notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="‚ö†Ô∏è <b>Titan Workflow Failed!</b>%0A%0A"
          MESSAGE="${MESSAGE}‚ùå Content generation encountered an error%0A%0A"
          MESSAGE="${MESSAGE}üîç <a href='https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'>View Logs</a>%0A%0A"
          MESSAGE="${MESSAGE}üí° Check GitHub Actions for details"
          
          curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="HTML" \
            -d text="${MESSAGE}"
```

---

## ‚úÖ WHAT'S NEW IN THIS VERSION

### 1. **Logo Integration** üé®
- Loads from `assets/brand/sayplay_logo.png`
- Base64 encoded (embedded in HTML)
- Fallback to emoji if not found
- Automatic detection

### 2. **Full SayPlay Branding** üéÅ
- Orange gradient header (#FF6B35)
- Blue call-to-action (#004E89)
- Professional footer
- Brand colors throughout
- Responsive design

### 3. **Enhanced Features** ‚ú®
- Meta tags for SEO
- Open Graph tags for sharing
- Mobile-responsive layout
- Professional typography
- Smooth animations

### 4. **Better Notifications** üì±
- Shows branding status
- Lists features included
- Brand color codes
- Asset locations

---

## üìã SETUP CHECKLIST

**To get full branding:**

- [ ] 1. Upload logo to `assets/brand/sayplay_logo.png`
- [ ] 2. Update workflow with file above
- [ ] 3. Commit all changes
- [ ] 4. Run workflow
- [ ] 5. Download article
- [ ] 6. See full SayPlay branding! üéâ

**Without logo (works now):**

- [ ] 1. Just update workflow
- [ ] 2. Commit & run
- [ ] 3. Will use emoji fallback (üéÅ SayPlay)
- [ ] 4. Upload logo later for automatic upgrade

---

## üéØ WHAT YOU GET

**Branded article includes:**

‚úÖ SayPlay logo (or emoji)  
‚úÖ Orange gradient header  
‚úÖ Brand colors throughout  
‚úÖ Professional typography  
‚úÖ Call-to-action button  
‚úÖ Branded footer  
‚úÖ Mobile responsive  
‚úÖ SEO optimized  
‚úÖ Social share ready  

**Value:** Professional blog posts worth ¬£100+ each!

---

## üöÄ COMMIT AND TEST

**Commit message:**
```
Add full SayPlay branding to articles - logo, colors, CTA
