name: Daily Titan Content (Blog + Pinterest)

on:
  # Schedule: Daily at 10 AM UTC (between video runs)
  schedule:
    - cron: '0 10 * * *'
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      content_type:
        description: 'What to generate'
        required: false
        default: 'blog'
        type: choice
        options:
          - 'blog'
          - 'pinterest-test'
          - 'both'

jobs:
  generate-blog:
    name: Generate Blog Article
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      # ============================================
      # SETUP
      # ============================================
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # ============================================
      # DEPENDENCIES
      # ============================================
      
      - name: Install Titan dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements_titan.txt
      
      # ============================================
      # CONFIGURATION
      # ============================================
      
      - name: Configure environment
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PINTEREST_TOKEN: ${{ secrets.PINTEREST_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Create .env for Titan
          cat > .env << EOF
          GEMINI_API_KEY=${GEMINI_API_KEY}
          PINTEREST_TOKEN=${PINTEREST_TOKEN}
          TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
          TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
          EOF
          
          echo "‚úì Titan environment configured"
      
      # ============================================
      # BLOG GENERATION
      # ============================================
      
      - name: Generate blog article
        id: blog
        run: |
          echo "üìù Generating blog article..."
          python titan_modules/blog/writer/article_generator.py
          
          # Extract article title
          if [ -f "test_article.html" ]; then
            TITLE=$(grep -oP '<h1>\K[^<]+' test_article.html 2>/dev/null || echo "Blog Article")
            echo "article_title=${TITLE}" >> $GITHUB_OUTPUT
            echo "‚úÖ Article generated: ${TITLE}"
          else
            echo "‚ùå Article generation failed"
            exit 1
          fi
      
      # ============================================
      # ARTIFACT STORAGE
      # ============================================
      
      - name: Upload blog article
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: blog-article-${{ github.run_number }}
          path: test_article.html
          retention-days: 7
      
      # ============================================
      # TELEGRAM NOTIFICATION
      # ============================================
      
      - name: Send to Telegram
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          TITLE="${{ steps.blog.outputs.article_title }}"
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          MESSAGE="üìù New Blog Article Generated!%0A%0A"
          MESSAGE="${MESSAGE}üì∞ Title: ${TITLE}%0A%0A"
          MESSAGE="${MESSAGE}‚¨áÔ∏è Download: ${DOWNLOAD_URL}%0A%0A"
          MESSAGE="${MESSAGE}üí° Next: Create Pinterest pin with product photo"
          
          curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="HTML" \
            -d text="${MESSAGE}"
          
          echo "‚úÖ Notification sent to Telegram"

  test-pinterest:
    name: Test Pinterest Connection
    runs-on: ubuntu-latest
    needs: generate-blog
    if: success()
    timeout-minutes: 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements_titan.txt
      
      - name: Configure environment
        env:
          PINTEREST_TOKEN: ${{ secrets.PINTEREST_TOKEN }}
        run: |
          cat > .env << EOF
          PINTEREST_TOKEN=${PINTEREST_TOKEN}
          EOF
      
      - name: Test Pinterest API
        id: pinterest
        run: |
          echo "üìå Testing Pinterest connection..."
          python titan_modules/distribution/publishers/pinterest_publisher.py
          
          echo "‚úÖ Pinterest ready for pin creation"
          echo "pinterest_status=ready" >> $GITHUB_OUTPUT
      
      - name: Notify Pinterest status
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="üìå Pinterest Status: READY%0A%0A"
          MESSAGE="${MESSAGE}‚úÖ API connection verified%0A"
          MESSAGE="${MESSAGE}üí° Ready to create pins manually%0A%0A"
          MESSAGE="${MESSAGE}Next steps:%0A"
          MESSAGE="${MESSAGE}1. Download blog article from GitHub%0A"
          MESSAGE="${MESSAGE}2. Create product photo%0A"
          MESSAGE="${MESSAGE}3. Create Pinterest pin with article link"
          
          curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}"

  # ============================================
  # FAILURE NOTIFICATION
  # ============================================

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [generate-blog, test-pinterest]
    if: failure()
    
    steps:
      - name: Send failure notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="‚ö†Ô∏è Titan workflow failed!%0A%0ACheck GitHub Actions: https://github.com/${{ github.repository }}/actions"

# ============================================
# WORKFLOW METADATA
# ============================================

# This workflow:
# - Runs daily at 10 AM UTC
# - Generates 1 blog article (SEO-optimized)
# - Tests Pinterest connection
# - Sends article to Telegram
# - Notifies when ready for manual pin creation
#
# SAFE MODE:
# - No automated Pinterest posting (requires images)
# - Manual pin creation (5 min/day)
# - Download article from GitHub Artifacts
# - Zero ban risk
