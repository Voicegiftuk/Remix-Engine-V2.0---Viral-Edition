name: Titan V4 Production

on:
  schedule:
    - cron: '0 10 * * *'  # Daily at 10 AM UTC
  workflow_dispatch:  # Manual trigger

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  generate-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install google-generativeai edge-tts jinja2 requests pillow
      
      - name: Prepare assets (Audio + Images)
        run: |
          echo "ğŸ“¦ Preparing brand assets..."
          
          mkdir -p runtime_assets
          
          # ==========================================
          # AUDIO FILES (Intro + Outro)
          # ==========================================
          
          echo ""
          echo "ğŸµ Audio files:"
          
          # Intro podcast (multiple possible locations)
          INTRO_FOUND=false
          
          if [ -f "assets/music/Voicegiftuk/Just tap.No app intro podkast sayplay.mp3" ]; then
            cp "assets/music/Voicegiftuk/Just tap.No app intro podkast sayplay.mp3" "runtime_assets/Just tap.No app intro podkast sayplay.mp3"
            echo "  âœ… Intro copied from: assets/music/Voicegiftuk/"
            INTRO_FOUND=true
          elif [ -f "assets/music/Just tap.No app intro podkast sayplay.mp3" ]; then
            cp "assets/music/Just tap.No app intro podkast sayplay.mp3" "runtime_assets/Just tap.No app intro podkast sayplay.mp3"
            echo "  âœ… Intro copied from: assets/music/"
            INTRO_FOUND=true
          else
            echo "  âš ï¸ Intro not found (will use TTS only)"
          fi
          
          # Outro podcast
          OUTRO_FOUND=false
          
          if [ -f "assets/music/Voicegiftuk/Just tap.no app final podkast.mp3" ]; then
            cp "assets/music/Voicegiftuk/Just tap.no app final podkast.mp3" "runtime_assets/Just tap.no app final podkast.mp3"
            echo "  âœ… Outro copied from: assets/music/Voicegiftuk/"
            OUTRO_FOUND=true
          elif [ -f "assets/music/Just tap.no app final podkast.mp3" ]; then
            cp "assets/music/Just tap.no app final podkast.mp3" "runtime_assets/Just tap.no app final podkast.mp3"
            echo "  âœ… Outro copied from: assets/music/"
            OUTRO_FOUND=true
          else
            echo "  âš ï¸ Outro not found (will use TTS only)"
          fi
          
          # ==========================================
          # IMAGE FILES (Logo + Mascots)
          # ==========================================
          
          echo ""
          echo "ğŸ–¼ï¸ Image files:"
          
          # SayPlay Logo
          if [ -f "assets/brand/Voicegiftuk/sayplay_logo.png" ]; then
            cp "assets/brand/Voicegiftuk/sayplay_logo.png" runtime_assets/sayplay_logo.png
            echo "  âœ… Logo copied"
          else
            echo "  âš ï¸ Logo not found"
          fi
          
          # Mylo & Gigi (prefer version with logo)
          if [ -f "assets/brand/Voicegiftuk/milo&gigi-razem-z-logo-sayplay.png" ]; then
            cp "assets/brand/Voicegiftuk/milo&gigi-razem-z-logo-sayplay.png" runtime_assets/milo-gigi.png
            echo "  âœ… Mascots (with logo) copied"
          elif [ -f "assets/brand/Voicegiftuk/milo&gigi razem no backround.png" ]; then
            cp "assets/brand/Voicegiftuk/milo&gigi razem no backround.png" runtime_assets/milo-gigi.png
            echo "  âœ… Mascots (no background) copied"
          else
            echo "  âš ï¸ Mascots not found"
          fi
          
          # Individual mascots (optional)
          if [ -f "assets/brand/Voicegiftuk/just milo looking from side.png" ]; then
            cp "assets/brand/Voicegiftuk/just milo looking from side.png" runtime_assets/milo-side.png
            echo "  âœ… Milo individual copied"
          fi
          
          if [ -f "assets/brand/Voicegiftuk/just gigi looking from side.png" ]; then
            cp "assets/brand/Voicegiftuk/just gigi looking from side.png" runtime_assets/gigi-side.png
            echo "  âœ… Gigi individual copied"
          fi
          
          # ==========================================
          # SUMMARY
          # ==========================================
          
          echo ""
          echo "ğŸ“‚ Available runtime assets:"
          ls -lh runtime_assets/
          
          echo ""
          echo "ğŸ“Š Asset status:"
          echo "  Intro audio: $([ "$INTRO_FOUND" = true ] && echo 'âœ…' || echo 'âŒ')"
          echo "  Outro audio: $([ "$OUTRO_FOUND" = true ] && echo 'âœ…' || echo 'âŒ')"
          [ -f "runtime_assets/sayplay_logo.png" ] && echo "  Logo: âœ…" || echo "  Logo: âŒ"
          [ -f "runtime_assets/milo-gigi.png" ] && echo "  Mascots: âœ…" || echo "  Mascots: âŒ"
      
      - name: Generate content with V4 PRODUCTION
        run: |
          echo "ğŸš€ Starting TITAN V4 PRODUCTION..."
          python titan_master_orchestrator_v4_production.py
      
      - name: Verify generated content
        run: |
          LATEST=$(ls -dt TITAN_OUTPUT_V4_* | head -1)
          
          if [ ! -d "$LATEST" ]; then
            echo "âŒ ERROR: Output directory not found!"
            exit 1
          fi
          
          echo "âœ… Output directory: $LATEST"
          echo ""
          
          # ==========================================
          # COUNT FILES
          # ==========================================
          
          SEO_COUNT=$(find $LATEST/web/seo -name '*.html' -type f 2>/dev/null | wc -l)
          BLOG_COUNT=$(find $LATEST/web/blog -name '*.html' -type f 2>/dev/null | wc -l)
          PODCAST_COUNT=$(find $LATEST/web/podcasts -name '*.mp3' -type f 2>/dev/null | wc -l)
          
          echo "ğŸ“Š Content Statistics:"
          echo "  ğŸ“ SEO pages: $SEO_COUNT"
          echo "  ğŸ“° Blog posts: $BLOG_COUNT"
          echo "  ğŸ™ï¸ Podcasts: $PODCAST_COUNT"
          echo ""
          
          # ==========================================
          # VERIFY SEO PAGES LENGTH
          # ==========================================
          
          echo "ğŸ“ SEO pages content verification:"
          SEO_SHORT_COUNT=0
          
          for file in $LATEST/web/seo/*.html; do
            if [ -f "$file" ]; then
              SIZE=$(wc -c < "$file")
              BASENAME=$(basename "$file")
              
              if [ $SIZE -lt 5000 ]; then
                echo "  âš ï¸ SHORT: $BASENAME ($SIZE bytes)"
                SEO_SHORT_COUNT=$((SEO_SHORT_COUNT + 1))
              else
                echo "  âœ… $BASENAME ($SIZE bytes)"
              fi
            fi
          done
          
          echo ""
          
          # ==========================================
          # VERIFY BLOG POSTS LENGTH
          # ==========================================
          
          echo "ğŸ“ Blog posts content verification:"
          BLOG_SHORT_COUNT=0
          
          for file in $LATEST/web/blog/*.html; do
            if [ -f "$file" ]; then
              SIZE=$(wc -c < "$file")
              BASENAME=$(basename "$file")
              
              if [ $SIZE -lt 6000 ]; then
                echo "  âš ï¸ SHORT: $BASENAME ($SIZE bytes)"
                BLOG_SHORT_COUNT=$((BLOG_SHORT_COUNT + 1))
              else
                echo "  âœ… $BASENAME ($SIZE bytes)"
              fi
            fi
          done
          
          echo ""
          
          # ==========================================
          # VERIFY PODCAST DURATION
          # ==========================================
          
          echo "ğŸ™ï¸ Podcast files verification:"
          PODCAST_SHORT_COUNT=0
          TOTAL_PODCAST_SIZE=0
          
          for file in $LATEST/web/podcasts/*.mp3; do
            if [ -f "$file" ]; then
              SIZE=$(wc -c < "$file")
              TOTAL_PODCAST_SIZE=$((TOTAL_PODCAST_SIZE + SIZE))
              BASENAME=$(basename "$file")
              SIZE_KB=$((SIZE / 1024))
              
              # Assuming ~1MB per minute of MP3 at 128kbps
              # 4 minutes should be ~4MB minimum (4,000,000 bytes)
              if [ $SIZE -lt 500000 ]; then
                echo "  âš ï¸ SHORT: $BASENAME (${SIZE_KB}KB - likely <1min)"
                PODCAST_SHORT_COUNT=$((PODCAST_SHORT_COUNT + 1))
              else
                EST_MIN=$((SIZE_KB / 1000))
                echo "  âœ… $BASENAME (${SIZE_KB}KB ~${EST_MIN}min)"
              fi
            fi
          done
          
          echo ""
          
          # ==========================================
          # VALIDATION CHECKS
          # ==========================================
          
          echo "ğŸ” Validation checks:"
          
          FAILED=false
          
          # Check minimum counts
          if [ "$SEO_COUNT" -lt 10 ]; then
            echo "  âŒ Expected 10 SEO pages, got $SEO_COUNT"
            FAILED=true
          else
            echo "  âœ… SEO pages count: $SEO_COUNT"
          fi
          
          if [ "$BLOG_COUNT" -lt 10 ]; then
            echo "  âŒ Expected 10 blog posts, got $BLOG_COUNT"
            FAILED=true
          else
            echo "  âœ… Blog posts count: $BLOG_COUNT"
          fi
          
          if [ "$PODCAST_COUNT" -lt 10 ]; then
            echo "  âŒ Expected 10 podcasts, got $PODCAST_COUNT"
            FAILED=true
          else
            echo "  âœ… Podcasts count: $PODCAST_COUNT"
          fi
          
          # Warn about short content
          if [ "$SEO_SHORT_COUNT" -gt 0 ]; then
            echo "  âš ï¸ WARNING: $SEO_SHORT_COUNT SEO pages may be too short"
          fi
          
          if [ "$BLOG_SHORT_COUNT" -gt 0 ]; then
            echo "  âš ï¸ WARNING: $BLOG_SHORT_COUNT blog posts may be too short"
          fi
          
          if [ "$PODCAST_SHORT_COUNT" -gt 0 ]; then
            echo "  âš ï¸ WARNING: $PODCAST_SHORT_COUNT podcasts may be too short"
          fi
          
          echo ""
          
          if [ "$FAILED" = true ]; then
            echo "âŒ Validation failed!"
            exit 1
          fi
          
          echo "âœ… All validation checks passed"
      
      - name: Prepare deployment folder
        run: |
          LATEST=$(ls -dt TITAN_OUTPUT_V4_* | head -1)
          echo "ğŸ“¦ Preparing deployment from: $LATEST"
          
          mkdir -p deploy
          
          # Copy all web content
          echo "ğŸ“ Copying web content..."
          cp -r $LATEST/web/* deploy/
          
          # Copy assets to deployment
          echo "ğŸ“ Copying runtime assets to deployment..."
          if [ -d "runtime_assets" ]; then
            mkdir -p deploy/assets
            
            # Copy images
            [ -f "runtime_assets/sayplay_logo.png" ] && cp runtime_assets/sayplay_logo.png deploy/assets/ && echo "  âœ… Logo copied to deploy"
            [ -f "runtime_assets/milo-gigi.png" ] && cp runtime_assets/milo-gigi.png deploy/assets/ && echo "  âœ… Mascots copied to deploy"
          fi
          
          # Verify deployment structure
          echo ""
          echo "ğŸ“‚ Deploy folder structure:"
          ls -lah deploy/
          
          echo ""
          echo "ğŸ“Š Deployment statistics:"
          echo "  Total files: $(find deploy -type f | wc -l)"
          echo "  SEO pages: $(find deploy/seo -name '*.html' -type f 2>/dev/null | wc -l)"
          echo "  Blog posts: $(find deploy/blog -name '*.html' -type f 2>/dev/null | wc -l)"
          echo "  Podcasts: $(find deploy/podcasts -name '*.mp3' -type f 2>/dev/null | wc -l)"
          echo "  Assets: $(find deploy/assets -type f 2>/dev/null | wc -l)"
          
          # Show directory sizes
          echo ""
          echo "ğŸ’¾ Directory sizes:"
          du -sh deploy/* 2>/dev/null || true
      
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
      
      - name: Deploy to Vercel
        run: |
          echo "ğŸš€ Starting Vercel deployment..."
          cd deploy
          
          echo "ğŸ“¥ Pulling Vercel configuration..."
          vercel pull --yes --environment=production --token=$VERCEL_TOKEN
          
          echo "ğŸ”¨ Building for production..."
          vercel build --prod --token=$VERCEL_TOKEN
          
          echo "ğŸŒ Deploying to production..."
          DEPLOY_URL=$(vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN)
          
          echo "âœ… Deployment complete!"
          echo "ğŸ”— URL: $DEPLOY_URL"
          
          echo "DEPLOY_URL=$DEPLOY_URL" >> $GITHUB_ENV
      
      - name: Verify deployment
        if: success()
        run: |
          echo "ğŸ” Verifying deployment..."
          sleep 15  # Wait for CDN propagation
          
          URLS=(
            "https://dashboard.sayplay.co.uk"
            "https://dashboard.sayplay.co.uk/seo"
            "https://dashboard.sayplay.co.uk/blog"
            "https://dashboard.sayplay.co.uk/podcasts"
          )
          
          echo ""
          echo "ğŸŒ Checking live URLs..."
          for URL in "${URLS[@]}"; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "  âœ… $URL - OK"
            else
              echo "  âš ï¸ $URL - HTTP $HTTP_CODE"
            fi
          done
          
          echo ""
          echo "âœ… Deployment verification complete"
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titan-v4-output-${{ github.run_number }}
          path: TITAN_OUTPUT_V4_*
          retention-days: 90
      
      - name: Success notification
        if: success()
        run: |
          LATEST=$(ls -dt TITAN_OUTPUT_V4_* | head -1)
          
          SEO_COUNT=$(find $LATEST/web/seo -name '*.html' -type f 2>/dev/null | wc -l)
          BLOG_COUNT=$(find $LATEST/web/blog -name '*.html' -type f 2>/dev/null | wc -l)
          PODCAST_COUNT=$(find $LATEST/web/podcasts -name '*.mp3' -type f 2>/dev/null | wc -l)
          
          # Calculate total podcast size
          TOTAL_SIZE=0
          for file in $LATEST/web/podcasts/*.mp3; do
            if [ -f "$file" ]; then
              SIZE=$(wc -c < "$file")
              TOTAL_SIZE=$((TOTAL_SIZE + SIZE))
            fi
          done
          TOTAL_MB=$((TOTAL_SIZE / 1024 / 1024))
          
          MESSAGE="âœ… <b>TITAN V4 PRODUCTION Complete!</b>%0A%0A<b>ğŸ“Š Content Generated:</b>%0AğŸ“ $SEO_COUNT SEO pages (1000+ chars)%0AğŸ“° $BLOG_COUNT blog posts (1500+ chars)%0AğŸ™ $PODCAST_COUNT podcasts (~${TOTAL_MB}MB total)%0A%0A<b>âœ¨ Features:</b>%0Aâœ“ Correct facts (60s voice, 30s video, 1yr hosting)%0Aâœ“ Intro/outro audio integration%0Aâœ“ 3 sales links per page%0Aâœ“ Logo %26 mascots on pages%0Aâœ“ Long-form content%0Aâœ“ Reddit trend-based topics%0A%0A<b>ğŸ”— Live URLs:</b>%0AğŸŒ <a href='https://dashboard.sayplay.co.uk'>Dashboard</a>%0AğŸ“ <a href='https://dashboard.sayplay.co.uk/seo'>SEO Pages</a>%0AğŸ“° <a href='https://dashboard.sayplay.co.uk/blog'>Blog</a>%0AğŸ™ <a href='https://dashboard.sayplay.co.uk/podcasts'>Podcasts</a>%0A%0Aâ± Run: #${{ github.run_number }}"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML" \
            -d "disable_web_page_preview=true" || true
      
      - name: Failure notification
        if: failure()
        run: |
          MESSAGE="âŒ <b>TITAN V4 Production Failed</b>%0A%0ARun: #${{ github.run_number }}%0AError during workflow execution%0A%0AğŸ“‹ <a href='https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'>View Error Logs</a>"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML" || true
