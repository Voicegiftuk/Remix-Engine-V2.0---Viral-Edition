name: Titan Full Automation

on:
  schedule:
    - cron: '0 10 * * *'  # Daily at 10 AM UTC
  workflow_dispatch:  # Manual trigger

jobs:
  generate-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install requests pillow google-generativeai edge-tts
      
      - name: Generate content
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
        run: |
          python titan_master_orchestrator_v2.py
      
      - name: Prepare deployment folder
        run: |
          LATEST=$(ls -dt TITAN_OUTPUT_* | head -1)
          echo "Latest output: $LATEST"
          
          # Copy web content to deploy folder
          mkdir -p deploy
          cp -r $LATEST/web/* deploy/
          
          # List what we're deploying
          echo "Contents of deploy folder:"
          ls -laR deploy/
          
          echo "Total files:"
          find deploy -type f | wc -l
          
          echo "File breakdown:"
          echo "Blog articles: $(find deploy/blog -name '*.html' 2>/dev/null | wc -l)"
          echo "SEO pages: $(find deploy/seo -name '*.html' 2>/dev/null | wc -l)"
          echo "Podcasts: $(find deploy/podcasts -name '*.mp3' 2>/dev/null | wc -l)"
      
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
      
      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          cd deploy
          vercel pull --yes --environment=production --token=$VERCEL_TOKEN
          vercel build --prod --token=$VERCEL_TOKEN
          vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titan-output-${{ github.run_number }}
          path: TITAN_OUTPUT_*
          retention-days: 30
      
      - name: Success notification
        if: success()
        run: |
          # Count generated files
          LATEST=$(ls -dt TITAN_OUTPUT_* | head -1)
          ARTICLES=$(find $LATEST/web/blog -name '*.html' 2>/dev/null | wc -l)
          PODCASTS=$(find $LATEST/web/podcasts -name '*.mp3' 2>/dev/null | wc -l)
          SEO=$(find $LATEST/web/seo -name '*.html' 2>/dev/null | wc -l)
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=HTML" \
            -d "text=âœ… <b>Titan Complete!</b>%0A%0AğŸ“ $ARTICLES articles%0AğŸ™ $PODCASTS podcasts%0AğŸ” $SEO SEO pages%0A%0AğŸŒ <a href='https://dashboard.sayplay.co.uk'>View Dashboard</a>%0AğŸ“š <a href='https://dashboard.sayplay.co.uk/blog'>View Blog</a>%0AğŸ§ <a href='https://dashboard.sayplay.co.uk/podcast.xml'>RSS Feed</a>" || true
      
      - name: Failure notification
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=HTML" \
            -d "text=âŒ <b>Titan Failed - Run #${{ github.run_number }}</b>%0A%0A<a href='https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'>View Error Logs</a>" || true
