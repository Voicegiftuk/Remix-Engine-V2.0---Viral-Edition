name: Titan V3 Full Automation

on:
  schedule:
    - cron: '0 10 * * *'  # Daily at 10 AM UTC
  workflow_dispatch:  # Manual trigger

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
  PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  generate-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install requests pillow google-generativeai edge-tts jinja2
      
      - name: Prepare assets (Logo + Mylo & Gigi)
        run: |
          echo "ğŸ“¦ Preparing brand assets..."
          
          mkdir -p runtime_assets
          
          # Copy SayPlay logo
          if [ -f "assets/brand/Voicegiftuk/sayplay_logo.png" ]; then
            cp "assets/brand/Voicegiftuk/sayplay_logo.png" runtime_assets/
            echo "âœ… Logo copied"
          else
            echo "âš ï¸ Logo not found"
          fi
          
          # Copy Mylo & Gigi (with logo version preferred)
          if [ -f "assets/brand/Voicegiftuk/milo&gigi-razem-z-logo-sayplay.png" ]; then
            cp "assets/brand/Voicegiftuk/milo&gigi-razem-z-logo-sayplay.png" runtime_assets/
            echo "âœ… Mylo & Gigi (with logo) copied"
          elif [ -f "assets/brand/Voicegiftuk/milo&gigi razem no backround.png" ]; then
            cp "assets/brand/Voicegiftuk/milo&gigi razem no backround.png" runtime_assets/milo-gigi-razem-no-backround.png
            echo "âœ… Mylo & Gigi (no background) copied"
          else
            echo "âš ï¸ Mylo & Gigi images not found"
          fi
          
          # Copy individual mascots (optional)
          if [ -f "assets/brand/Voicegiftuk/just milo looking from side.png" ]; then
            cp "assets/brand/Voicegiftuk/just milo looking from side.png" runtime_assets/milo-side.png
            echo "âœ… Milo copied"
          fi
          
          if [ -f "assets/brand/Voicegiftuk/just gigi looking from side.png" ]; then
            cp "assets/brand/Voicegiftuk/just gigi looking from side.png" runtime_assets/gigi-side.png
            echo "âœ… Gigi copied"
          fi
          
          echo ""
          echo "ğŸ“‚ Available assets:"
          ls -lh runtime_assets/
      
      - name: Generate content with V3 FINAL
        run: |
          echo "ğŸš€ Starting TITAN V3 FINAL..."
          python titan_master_orchestrator_v3_final.py
      
      - name: Verify generated content
        run: |
          LATEST=$(ls -dt TITAN_OUTPUT_V3_* | head -1)
          
          if [ ! -d "$LATEST" ]; then
            echo "âŒ ERROR: Output directory not found!"
            exit 1
          fi
          
          echo "âœ… Output directory: $LATEST"
          
          # Check directories
          for dir in blog podcasts dashboard seo; do
            if [ ! -d "$LATEST/web/$dir" ]; then
              echo "âŒ ERROR: /$dir directory missing!"
              exit 1
            fi
          done
          
          # Count files
          BLOG_COUNT=$(find $LATEST/web/blog -name '*.html' -not -name 'index.html' -type f 2>/dev/null | wc -l)
          PODCAST_COUNT=$(find $LATEST/web/podcasts -name '*.mp3' -type f 2>/dev/null | wc -l)
          SEO_COUNT=$(find $LATEST/web/seo -name '*.html' -not -name 'index.html' -type f 2>/dev/null | wc -l)
          ASSET_COUNT=$(find $LATEST/web/assets -type f 2>/dev/null | wc -l)
          
          echo ""
          echo "ğŸ“Š Content Statistics:"
          echo "  ğŸ“ Blog articles: $BLOG_COUNT"
          echo "  ğŸ™ Podcasts: $PODCAST_COUNT"
          echo "  ğŸŒ SEO pages: $SEO_COUNT"
          echo "  ğŸ–¼ Assets (images with logo): $ASSET_COUNT"
          
          # Check index pages
          echo ""
          echo "ğŸ“„ Index Pages:"
          [ -f "$LATEST/web/blog/index.html" ] && echo "  âœ… Blog index" || echo "  âŒ Blog index MISSING"
          [ -f "$LATEST/web/podcasts/index.html" ] && echo "  âœ… Podcasts index" || echo "  âŒ Podcasts index MISSING"
          [ -f "$LATEST/web/seo/index.html" ] && echo "  âœ… SEO index" || echo "  âŒ SEO index MISSING"
          [ -f "$LATEST/web/dashboard/index.html" ] && echo "  âœ… Dashboard" || echo "  âŒ Dashboard MISSING"
          
          # Check podcast files
          echo ""
          echo "ğŸ™ Podcast Files:"
          [ -f "$LATEST/web/podcast-cover.jpg" ] && echo "  âœ… Podcast cover (1400x1400 with logo)" || echo "  âš ï¸ Cover missing"
          [ -f "$LATEST/web/podcast.xml" ] && echo "  âœ… RSS feed" || echo "  âš ï¸ RSS missing"
          
          if [ "$BLOG_COUNT" -eq 0 ]; then
            echo ""
            echo "âŒ ERROR: No blog articles generated!"
            exit 1
          fi
          
          if [ "$SEO_COUNT" -lt 90 ]; then
            echo ""
            echo "âš ï¸ WARNING: Only $SEO_COUNT SEO pages (expected ~100)"
          fi
          
          echo ""
          echo "âœ… Content verification passed"
      
      - name: Prepare deployment folder
        run: |
          LATEST=$(ls -dt TITAN_OUTPUT_V3_* | head -1)
          echo "ğŸ“¦ Preparing deployment from: $LATEST"
          
          mkdir -p deploy
          
          echo "ğŸ“ Copying web content..."
          cp -r $LATEST/web/* deploy/
          
          echo ""
          echo "ğŸ“‚ Deploy folder structure:"
          ls -lah deploy/
          
          echo ""
          echo "ğŸ“Š Deployment statistics:"
          echo "  Total files: $(find deploy -type f | wc -l)"
          echo "  Blog HTMLs: $(find deploy/blog -name '*.html' -type f 2>/dev/null | wc -l)"
          echo "  Podcasts: $(find deploy/podcasts -name '*.mp3' -type f 2>/dev/null | wc -l)"
          echo "  SEO pages: $(find deploy/seo -name '*.html' -type f 2>/dev/null | wc -l)"
          echo "  Assets: $(find deploy/assets -type f 2>/dev/null | wc -l)"
          
          echo ""
          echo "ğŸ” Critical files check:"
          [ -f "deploy/dashboard/index.html" ] && echo "  âœ… Dashboard" || echo "  âŒ Dashboard MISSING"
          [ -f "deploy/blog/index.html" ] && echo "  âœ… Blog index" || echo "  âŒ Blog index MISSING"
          [ -f "deploy/podcasts/index.html" ] && echo "  âœ… Podcasts index" || echo "  âŒ Podcasts index MISSING"
          [ -f "deploy/seo/index.html" ] && echo "  âœ… SEO index" || echo "  âŒ SEO index MISSING"
          [ -f "deploy/podcast.xml" ] && echo "  âœ… RSS feed" || echo "  âŒ RSS MISSING"
          [ -f "deploy/podcast-cover.jpg" ] && echo "  âœ… Podcast cover" || echo "  âŒ Cover MISSING"
      
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
      
      - name: Deploy to Vercel
        run: |
          echo "ğŸš€ Starting Vercel deployment..."
          cd deploy
          
          echo "ğŸ“¥ Pulling Vercel configuration..."
          vercel pull --yes --environment=production --token=$VERCEL_TOKEN
          
          echo "ğŸ”¨ Building for production..."
          vercel build --prod --token=$VERCEL_TOKEN
          
          echo "ğŸŒ Deploying to production..."
          DEPLOY_URL=$(vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN)
          
          echo "âœ… Deployment complete!"
          echo "ğŸ”— URL: $DEPLOY_URL"
          
          echo "DEPLOY_URL=$DEPLOY_URL" >> $GITHUB_ENV
      
      - name: Verify deployment
        if: success()
        run: |
          echo "ğŸ” Verifying deployment..."
          sleep 15
          
          URLS=(
            "https://dashboard.sayplay.co.uk"
            "https://dashboard.sayplay.co.uk/blog"
            "https://dashboard.sayplay.co.uk/podcasts"
            "https://dashboard.sayplay.co.uk/seo"
            "https://dashboard.sayplay.co.uk/podcast.xml"
            "https://dashboard.sayplay.co.uk/podcast-cover.jpg"
          )
          
          echo ""
          echo "ğŸŒ Checking live URLs..."
          for URL in "${URLS[@]}"; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "  âœ… $URL - OK"
            else
              echo "  âš ï¸ $URL - HTTP $HTTP_CODE"
            fi
          done
          
          echo ""
          echo "âœ… Deployment verification complete"
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titan-v3-output-${{ github.run_number }}
          path: TITAN_OUTPUT_V3_*
          retention-days: 90
      
      - name: Success notification
        if: success()
        run: |
          LATEST=$(ls -dt TITAN_OUTPUT_V3_* | head -1)
          ARTICLES=$(find $LATEST/web/blog -name '*.html' -not -name 'index.html' -type f 2>/dev/null | wc -l)
          PODCASTS=$(find $LATEST/web/podcasts -name '*.mp3' -type f 2>/dev/null | wc -l)
          SEO_PAGES=$(find $LATEST/web/seo -name '*.html' -not -name 'index.html' -type f 2>/dev/null | wc -l)
          
          MESSAGE="âœ… <b>TITAN V3 FINAL Complete!</b>%0A%0A<b>ğŸ“Š Content Generated:</b>%0AğŸ“ $ARTICLES blog articles (Reddit trends)%0AğŸ™ $PODCASTS podcasts (unique numbering)%0AğŸŒ $SEO_PAGES SEO pages%0A%0A<b>âœ¨ Features:</b>%0Aâœ“ Real Logo PNG on all images%0Aâœ“ Mylo %26 Gigi product images%0Aâœ“ Podcast cover 1400x1400%0Aâœ“ RSS feed (Apple Podcasts)%0Aâœ“ GitHub state management%0Aâœ“ Premium Jinja2 design%0A%0A<b>ğŸ”— Live URLs:</b>%0AğŸŒ <a href='https://dashboard.sayplay.co.uk'>Dashboard</a>%0AğŸ“š <a href='https://dashboard.sayplay.co.uk/blog'>Blog</a>%0AğŸ§ <a href='https://dashboard.sayplay.co.uk/podcasts'>Podcasts</a>%0AğŸ—º <a href='https://dashboard.sayplay.co.uk/seo'>SEO Pages</a>%0AğŸ“¡ <a href='https://dashboard.sayplay.co.uk/podcast.xml'>RSS Feed</a>%0A%0Aâ± Run: #${{ github.run_number }}"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML" \
            -d "disable_web_page_preview=true" || true
      
      - name: Failure notification
        if: failure()
        run: |
          MESSAGE="âŒ <b>TITAN V3 Failed</b>%0A%0ARun: #${{ github.run_number }}%0AError in workflow execution%0A%0AğŸ“‹ <a href='https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'>View Logs</a>"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML" || true
