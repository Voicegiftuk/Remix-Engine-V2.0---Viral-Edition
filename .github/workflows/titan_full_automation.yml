name: Titan Full Automation

on:
  schedule:
    - cron: '0 10 * * *'  # Daily at 10 AM UTC
  workflow_dispatch:  # Manual trigger

jobs:
  generate-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install requests pillow google-generativeai edge-tts
      
      - name: Generate content
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
        run: |
          python titan_master_orchestrator_v2.py
      
      - name: Verify generated content
        run: |
          LATEST=$(ls -dt TITAN_OUTPUT_* | head -1)
          
          if [ ! -d "$LATEST" ]; then
            echo "âŒ ERROR: Output directory not found!"
            exit 1
          fi
          
          echo "âœ… Output directory: $LATEST"
          
          # Check for required files
          if [ ! -d "$LATEST/web/blog" ]; then
            echo "âŒ ERROR: Blog directory missing!"
            exit 1
          fi
          
          if [ ! -d "$LATEST/web/podcasts" ]; then
            echo "âŒ ERROR: Podcasts directory missing!"
            exit 1
          fi
          
          if [ ! -d "$LATEST/web/dashboard" ]; then
            echo "âŒ ERROR: Dashboard directory missing!"
            exit 1
          fi
          
          # Count files
          BLOG_COUNT=$(find $LATEST/web/blog -name '*.html' -type f 2>/dev/null | wc -l)
          PODCAST_COUNT=$(find $LATEST/web/podcasts -name '*.mp3' -type f 2>/dev/null | wc -l)
          
          echo "ğŸ“Š Content Statistics:"
          echo "  ğŸ“ Blog articles: $BLOG_COUNT"
          echo "  ğŸ™ Podcasts: $PODCAST_COUNT"
          
          if [ "$BLOG_COUNT" -eq 0 ]; then
            echo "âŒ ERROR: No blog articles generated!"
            exit 1
          fi
          
          if [ "$PODCAST_COUNT" -eq 0 ]; then
            echo "âš ï¸ WARNING: No podcasts generated (Edge TTS may be unavailable)"
          fi
          
          echo "âœ… Content verification passed"
      
      - name: Prepare deployment folder
        run: |
          LATEST=$(ls -dt TITAN_OUTPUT_* | head -1)
          echo "ğŸ“¦ Preparing deployment from: $LATEST"
          
          # Create deploy folder
          mkdir -p deploy
          
          # Copy web content
          echo "ğŸ“ Copying web content..."
          cp -r $LATEST/web/* deploy/
          
          # Verify deployment folder
          echo ""
          echo "ğŸ“‚ Deploy folder structure:"
          ls -lah deploy/
          
          echo ""
          echo "ğŸ“Š File counts in deploy folder:"
          echo "  Total files: $(find deploy -type f | wc -l)"
          echo "  Blog HTMLs: $(find deploy/blog -name '*.html' -type f 2>/dev/null | wc -l)"
          echo "  Blog index: $([ -f deploy/blog/index.html ] && echo 'âœ“' || echo 'âœ—')"
          echo "  Podcasts MP3s: $(find deploy/podcasts -name '*.mp3' -type f 2>/dev/null | wc -l)"
          echo "  Podcasts index: $([ -f deploy/podcasts/index.html ] && echo 'âœ“' || echo 'âœ—')"
          echo "  Dashboard: $([ -f deploy/dashboard/index.html ] && echo 'âœ“' || echo 'âœ—')"
          echo "  RSS feed: $([ -f deploy/podcast.xml ] && echo 'âœ“' || echo 'âœ—')"
          echo "  Podcast cover: $([ -f deploy/podcast-cover.jpg ] && echo 'âœ“' || echo 'âœ—')"
          
          # Detailed file listing
          echo ""
          echo "ğŸ“‹ Detailed contents:"
          echo ""
          echo "Blog files:"
          ls -lh deploy/blog/*.html 2>/dev/null | head -5 || echo "  No blog files"
          echo ""
          echo "Podcast files:"
          ls -lh deploy/podcasts/*.mp3 2>/dev/null | head -5 || echo "  No podcast files"
          echo ""
          echo "Other files:"
          ls -lh deploy/*.{xml,jpg} 2>/dev/null || echo "  No RSS/cover files"
      
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
      
      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "ğŸš€ Starting Vercel deployment..."
          cd deploy
          
          echo "ğŸ“¥ Pulling Vercel configuration..."
          vercel pull --yes --environment=production --token=$VERCEL_TOKEN
          
          echo "ğŸ”¨ Building for production..."
          vercel build --prod --token=$VERCEL_TOKEN
          
          echo "ğŸŒ Deploying to production..."
          DEPLOY_URL=$(vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN)
          
          echo "âœ… Deployment complete!"
          echo "ğŸ”— URL: $DEPLOY_URL"
          
          # Save URL for later steps
          echo "DEPLOY_URL=$DEPLOY_URL" >> $GITHUB_ENV
      
      - name: Verify deployment
        if: success()
        run: |
          echo "ğŸ” Verifying deployment..."
          
          # Wait a bit for CDN
          sleep 10
          
          # Check main dashboard
          echo "Checking: https://dashboard.sayplay.co.uk"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://dashboard.sayplay.co.uk)
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Dashboard is live (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸ Dashboard returned HTTP $HTTP_CODE"
          fi
          
          # Check blog index
          echo "Checking: https://dashboard.sayplay.co.uk/blog"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://dashboard.sayplay.co.uk/blog)
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Blog index is live (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸ Blog index returned HTTP $HTTP_CODE"
          fi
          
          # Check podcasts index
          echo "Checking: https://dashboard.sayplay.co.uk/podcasts"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://dashboard.sayplay.co.uk/podcasts)
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Podcasts index is live (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸ Podcasts index returned HTTP $HTTP_CODE"
          fi
          
          echo ""
          echo "âœ… Deployment verification complete"
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titan-output-${{ github.run_number }}
          path: TITAN_OUTPUT_*
          retention-days: 30
      
      - name: Success notification
        if: success()
        run: |
          # Count generated files
          LATEST=$(ls -dt TITAN_OUTPUT_* | head -1)
          ARTICLES=$(find $LATEST/web/blog -name '*.html' -type f 2>/dev/null | wc -l)
          PODCASTS=$(find $LATEST/web/podcasts -name '*.mp3' -type f 2>/dev/null | wc -l)
          
          # Check for index pages
          BLOG_INDEX=$([ -f $LATEST/web/blog/index.html ] && echo "âœ“" || echo "âœ—")
          PODCAST_INDEX=$([ -f $LATEST/web/podcasts/index.html ] && echo "âœ“" || echo "âœ—")
          DASHBOARD=$([ -f $LATEST/web/dashboard/index.html ] && echo "âœ“" || echo "âœ—")
          RSS_FEED=$([ -f $LATEST/web/podcast.xml ] && echo "âœ“" || echo "âœ—")
          
          # Calculate podcasts only if they exist
          if [ "$PODCASTS" -gt 0 ]; then
            PODCAST_INFO="ğŸ™ $PODCASTS podcasts (3-5 min + jingles)"
          else
            PODCAST_INFO="âš ï¸ No podcasts (Edge TTS unavailable)"
          fi
          
          # Send Telegram notification
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=HTML" \
            -d "text=âœ… <b>Titan V2 Complete!</b>%0A%0A<b>ğŸ“Š Content Generated:</b>%0AğŸ“ $ARTICLES unique articles%0A$PODCAST_INFO%0A%0A<b>ğŸ“„ Index Pages:</b>%0ABlog index: $BLOG_INDEX%0APodcast index: $PODCAST_INDEX%0ADashboard: $DASHBOARD%0ARSS feed: $RSS_FEED%0A%0A<b>ğŸ”— Live URLs:</b>%0AğŸŒ <a href='https://dashboard.sayplay.co.uk'>Main Dashboard</a>%0AğŸ“š <a href='https://dashboard.sayplay.co.uk/blog'>Blog Index</a>%0AğŸ§ <a href='https://dashboard.sayplay.co.uk/podcasts'>Podcast Index</a>%0AğŸ“¡ <a href='https://dashboard.sayplay.co.uk/podcast.xml'>RSS Feed</a>%0A%0Aâ± Build: #${{ github.run_number }}" || true
      
      - name: Failure notification
        if: failure()
        run: |
          # Get error details
          LATEST=$(ls -dt TITAN_OUTPUT_* 2>/dev/null | head -1)
          
          if [ -n "$LATEST" ]; then
            ERROR_MSG="Generated output found but deployment failed"
          else
            ERROR_MSG="Content generation failed"
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=HTML" \
            -d "text=âŒ <b>Titan V2 Failed</b>%0A%0A<b>Run:</b> #${{ github.run_number }}%0A<b>Error:</b> $ERROR_MSG%0A%0A<a href='https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'>ğŸ“‹ View Error Logs</a>" || true
