name: Titan Full Automation

on:
  schedule:
    - cron: '0 10 * * *'
  workflow_dispatch:

jobs:
  generate-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests pillow
      
      - name: Generate content
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
        run: |
          python titan_master_orchestrator_v2.py
      
      - name: Generate RSS feed
        run: |
          python scripts/generate_podcast_rss.py || true
      
      - name: Prepare deployment folder
        run: |
          LATEST=$(ls -dt TITAN_OUTPUT_* | head -1)
          echo "Latest output: $LATEST"
          
          # Copy web content to deploy folder
          mkdir -p deploy
          cp -r $LATEST/web/* deploy/
          
          # List what we're deploying
          echo "Contents of deploy folder:"
          ls -laR deploy/
          
          echo "Checking file count:"
          find deploy -type f | wc -l
      
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
      
      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          cd deploy
          vercel pull --yes --environment=production --token=$VERCEL_TOKEN
          vercel build --prod --token=$VERCEL_TOKEN
          vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titan-output-${{ github.run_number }}
          path: TITAN_OUTPUT_*
          retention-days: 30
      
      - name: Success notification
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=HTML" \
            -d "text=‚úÖ <b>Titan Complete!</b>%0A%0Aüìù 10 articles live%0Aüåê <a href='https://dashboard.sayplay.co.uk'>View Dashboard</a>%0Aüìö <a href='https://dashboard.sayplay.co.uk/blog'>View Blog</a>" || true
      
      - name: Failure notification
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=HTML" \
            -d "text=‚ùå <b>Titan Failed</b>%0A%0A<a href='https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'>View Logs</a>" || true
