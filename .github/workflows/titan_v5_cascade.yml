name: Titan V5 CASCADE

on:
  schedule:
    - cron: '0 10 * * *'  # Codziennie 10:00 UTC
  workflow_dispatch:  # RÄ™czne uruchomienie

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  generate-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          echo "âœ… System dependencies installed"
      
      - name: Install Python packages
        run: |
          pip install --upgrade pip
          pip install google-generativeai edge-tts jinja2 requests pillow
          echo "âœ… Python packages installed"
      
      - name: Prepare runtime assets
        run: |
          mkdir -p runtime_assets
          echo "ðŸ“ Preparing assets..."
          
          # Audio files (CORRECT PATHS - no Voicegiftuk)
          if [ -f "assets/music/Just tap.No app intro podkast sayplay.mp3" ]; then
            cp "assets/music/Just tap.No app intro podkast sayplay.mp3" runtime_assets/
            echo "  âœ… Intro audio: assets/music/"
          else
            echo "  âš ï¸ Intro audio NOT FOUND"
          fi
          
          if [ -f "assets/music/Just tap.no app final podkast.mp3" ]; then
            cp "assets/music/Just tap.no app final podkast.mp3" runtime_assets/
            echo "  âœ… Outro audio: assets/music/"
          else
            echo "  âš ï¸ Outro audio NOT FOUND"
          fi
          
          # Logo (CORRECT PATH - no Voicegiftuk subfolder)
          if [ -f "assets/brand/sayplay_logo.png" ]; then
            cp "assets/brand/sayplay_logo.png" runtime_assets/
            echo "  âœ… Logo: assets/brand/sayplay_logo.png"
          else
            echo "  âš ï¸ Logo NOT FOUND at assets/brand/sayplay_logo.png"
            ls -la assets/brand/ || true
          fi
          
          # Mascots (CORRECT PATH - no Voicegiftuk subfolder)
          if [ -f "assets/brand/milo&gigi-razem-z-logo-sayplay.png" ]; then
            cp "assets/brand/milo&gigi-razem-z-logo-sayplay.png" runtime_assets/milo-gigi.png
            echo "  âœ… Mascots (with logo): assets/brand/"
          elif [ -f "assets/brand/milo&gigi razem no backround.png" ]; then
            cp "assets/brand/milo&gigi razem no backround.png" runtime_assets/milo-gigi.png
            echo "  âœ… Mascots (no background): assets/brand/"
          else
            echo "  âš ï¸ Mascots NOT FOUND"
            ls -la assets/brand/ || true
          fi
          
          echo ""
          echo "ðŸ“Š Runtime assets prepared:"
          ls -lh runtime_assets/
      
      - name: Generate content (CASCADE MODE)
        run: |
          echo "ðŸš€ TITAN V5 CASCADE - Starting content generation..."
          echo ""
          python titan_master_orchestrator_v5_cascade.py
          echo ""
          echo "âœ… Content generation complete"
      
      - name: Verify generated content
        run: |
          echo "ðŸ” Verifying generated content..."
          
          LATEST=$(ls -dt TITAN_OUTPUT_V5_* | head -1)
          echo "Latest output: $LATEST"
          
          SEO_COUNT=$(find $LATEST/web/seo -name '*.html' 2>/dev/null | wc -l)
          BLOG_COUNT=$(find $LATEST/web/blog -name '*.html' 2>/dev/null | wc -l)
          PODCAST_COUNT=$(find $LATEST/web/podcasts -name '*.mp3' 2>/dev/null | wc -l)
          
          echo ""
          echo "ðŸ“Š Content Statistics:"
          echo "  SEO Pages:    $SEO_COUNT"
          echo "  Blog Posts:   $BLOG_COUNT"
          echo "  Podcasts:     $PODCAST_COUNT"
          echo ""
          
          # Check file sizes
          echo "ðŸ“ SEO Page Sizes:"
          find $LATEST/web/seo -name '*.html' -exec wc -c {} \; | head -5
          echo ""
          
          echo "ðŸ“ Blog Post Sizes:"
          find $LATEST/web/blog -name '*.html' -exec wc -c {} \; | head -5
          echo ""
          
          echo "ðŸ“ Podcast Sizes:"
          find $LATEST/web/podcasts -name '*.mp3' -exec wc -c {} \; | head -5
          echo ""
          
          # Validation
          if [ "$SEO_COUNT" -ge 10 ] && [ "$BLOG_COUNT" -ge 10 ] && [ "$PODCAST_COUNT" -ge 10 ]; then
            echo "âœ… All content generated successfully!"
          else
            echo "âŒ Content generation incomplete!"
            echo "Expected: 10 SEO, 10 Blog, 10 Podcasts"
            echo "Got: $SEO_COUNT SEO, $BLOG_COUNT Blog, $PODCAST_COUNT Podcasts"
            exit 1
          fi
      
      - name: Prepare deployment package
        run: |
          echo "ðŸ“¦ Preparing deployment..."
          
          LATEST=$(ls -dt TITAN_OUTPUT_V5_* | head -1)
          mkdir -p deploy
          
          # Copy all web content
          cp -r $LATEST/web/* deploy/
          
          echo "âœ… Deployment package ready"
          ls -lh deploy/
      
      - name: Deploy to Vercel
        run: |
          echo "ðŸš€ Deploying to Vercel..."
          
          npm install --global vercel@latest
          
          cd deploy
          
          # Pull Vercel environment
          vercel pull --yes --environment=production --token=$VERCEL_TOKEN
          
          # Build for production
          vercel build --prod --token=$VERCEL_TOKEN
          
          # Deploy to production
          DEPLOY_URL=$(vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN)
          
          echo "âœ… Deployed to: $DEPLOY_URL"
          echo "DEPLOY_URL=$DEPLOY_URL" >> $GITHUB_ENV
      
      - name: Send success notification
        if: success()
        run: |
          LATEST=$(ls -dt TITAN_OUTPUT_V5_* | head -1)
          SEO_COUNT=$(find $LATEST/web/seo -name '*.html' 2>/dev/null | wc -l)
          BLOG_COUNT=$(find $LATEST/web/blog -name '*.html' 2>/dev/null | wc -l)
          PODCAST_COUNT=$(find $LATEST/web/podcasts -name '*.mp3' 2>/dev/null | wc -l)
          
          MESSAGE="âœ… TITAN V5 CASCADE Complete!%0A%0A"
          MESSAGE="${MESSAGE}ðŸ“Š Generated:%0A"
          MESSAGE="${MESSAGE}â€¢ ${SEO_COUNT} SEO pages%0A"
          MESSAGE="${MESSAGE}â€¢ ${BLOG_COUNT} Blog posts%0A"
          MESSAGE="${MESSAGE}â€¢ ${PODCAST_COUNT} Podcasts%0A%0A"
          MESSAGE="${MESSAGE}ðŸ”§ System: 3-Tier AI Cascade%0A"
          MESSAGE="${MESSAGE}âœ¨ Facts: 60s voice, 30s video, 1yr hosting%0A%0A"
          MESSAGE="${MESSAGE}ðŸ”— dashboard.sayplay.co.uk"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML" || true
          
          echo "âœ… Success notification sent"
      
      - name: Send failure notification
        if: failure()
        run: |
          MESSAGE="âŒ TITAN V5 CASCADE Failed!%0A%0A"
          MESSAGE="${MESSAGE}Please check GitHub Actions logs%0A"
          MESSAGE="${MESSAGE}ðŸ”— github.com/${{ github.repository }}/actions"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" || true
          
          echo "âŒ Failure notification sent"
      
      - name: Upload artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: titan-v5-debug-logs
          path: |
            TITAN_OUTPUT_V5_*/
            runtime_assets/
          retention-days: 7
      
      - name: Cleanup old outputs
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up..."
          
          # Keep only the 3 most recent outputs
          ls -dt TITAN_OUTPUT_V5_* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null || true
          
          echo "âœ… Cleanup complete"
