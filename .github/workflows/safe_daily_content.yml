name: Safe Daily Content Generation (V2.0)

on:
  # Schedule: 3 times daily (9 AM, 3 PM, 9 PM UTC)
  schedule:
    - cron: '0 9,15,21 * * *'
  
  # Manual trigger with options
  workflow_dispatch:
    inputs:
      video_count:
        description: 'Number of videos to generate'
        required: false
        default: '3'
        type: choice
        options:
          - '1'
          - '3'
          - '5'
          - '10'
      
      platform:
        description: 'Target platform'
        required: false
        default: 'instagram'
        type: choice
        options:
          - 'instagram'
          - 'tiktok'

jobs:
  generate-and-send:
    name: Generate & Send to Telegram
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      # ============================================
      # SETUP
      # ============================================
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # ============================================
      # SYSTEM DEPENDENCIES
      # ============================================
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ffmpeg \
            imagemagick \
            chromium-browser \
            chromium-chromedriver \
            fonts-liberation
          
          # Verify installations
          ffmpeg -version
          convert -version
          chromium-browser --version
      
      # ============================================
      # PYTHON DEPENDENCIES
      # ============================================
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      # ============================================
      # CONFIGURATION
      # ============================================
      
      - name: Configure environment
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Create .env file
          cat > .env << EOF
          GEMINI_API_KEY=${GEMINI_API_KEY}
          TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
          TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
          
          # V2.0 Settings (Safe Mode)
          SAFE_MODE=true
          ALLOW_AUTO_POSTING=false
          ENABLE_VOICEOVER=true
          USE_PRO_OVERLAYS=true
          ENABLE_HASH_BREAKING=true
          
          # Video Settings
          VIDEO_WIDTH=1080
          VIDEO_HEIGHT=1920
          VIDEO_FPS=30
          
          # Voice Settings
          DEFAULT_VOICE=tiktok_girl
          VOICE_RATE_VARIATION=true
          
          # Overlay Settings
          DEFAULT_OVERLAY_STYLE=tiktok
          OVERLAY_POSITION=top
          EOF
          
          echo "✓ Environment configured"
      
      # ============================================
      # CONTENT GENERATION
      # ============================================
      
      - name: Generate content
        id: generate
        run: |
          # Determine video count
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VIDEO_COUNT="${{ github.event.inputs.video_count }}"
            PLATFORM="${{ github.event.inputs.platform }}"
          else
            VIDEO_COUNT="3"
            PLATFORM="instagram"
          fi
          
          echo "Generating ${VIDEO_COUNT} videos for ${PLATFORM}..."
          
          # Run main workflow
          python main_v2.py --mode daily \
            --count ${VIDEO_COUNT} \
            --platform ${PLATFORM}
          
          echo "video_count=${VIDEO_COUNT}" >> $GITHUB_OUTPUT
          echo "platform=${PLATFORM}" >> $GITHUB_OUTPUT
      
      # ============================================
      # ARTIFACT STORAGE
      # ============================================
      
      - name: Upload generated content
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: generated-content-${{ github.run_number }}
          path: |
            output/videos/*.mp4
            output/images/*.png
            logs/*.log
          retention-days: 7
      
      # ============================================
      # NOTIFICATIONS
      # ============================================
      
      - name: Notify success
        if: success()
        run: |
          echo "✅ Workflow completed successfully"
          echo "Videos sent to Telegram"
          echo "Check your phone to post manually"
      
      - name: Notify failure
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Send failure notification to Telegram
          curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="⚠️ Remix Engine V2.0 workflow failed. Check GitHub Actions logs."
      
      # ============================================
      # CLEANUP
      # ============================================
      
      - name: Cleanup temp files
        if: always()
        run: |
          rm -rf assets/temp/*
          echo "✓ Temp files cleaned"

# ============================================
# WORKFLOW METADATA
# ============================================

# This workflow:
# - Runs automatically 3x daily
# - Generates videos with V2.0 features
# - Sends to Telegram (safe mode)
# - Stores artifacts for 7 days
# - Notifies on failure
#
# SAFE MODE ENABLED:
# - No automated posting to Instagram/TikTok
# - Zero ban risk
# - Manual posting takes 30 seconds
# - Can add trending audio in app
