name: Titan V10 Ultimate Agency

on:
  schedule:
    - cron: '0 10 * * *'
  workflow_dispatch:

permissions:
  contents: write

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  agency-run:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg jq
          pip install --upgrade pip
          pip install google-generativeai edge-tts jinja2 requests pillow
      
      - name: Setup Workspace
        run: |
          mkdir -p website
          mkdir -p social_media
          mkdir -p runtime_assets
          # Copy Assets (Ignore errors if missing)
          [ -f "assets/music/Just tap.No app intro podkast sayplay.mp3" ] && cp "assets/music/Just tap.No app intro podkast sayplay.mp3" runtime_assets/ || true
          [ -f "assets/brand/sayplay_logo.png" ] && cp "assets/brand/sayplay_logo.png" runtime_assets/ || true
      
      - name: Load Analytics
        run: |
          if [ ! -f "analytics_history.json" ]; then
            echo '{"history":[]}' > analytics_history.json
          fi
      
      - name: Start Marketing Engine
        run: python titan_v10_ultimate.py
      
      # --- NEW STEP: Backup ZIP Upload ---
      - name: Upload Social Assets to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: Social-Media-Campaigns
          path: social_media/
      # -----------------------------------

      - name: Save & Commit
        run: |
          git config --local user.email "agency@sayplay.co.uk"
          git config --local user.name "Titan V10 Agency"
          git add website/ social_media/ analytics_history.json
          
          if git diff --staged --quiet; then
            echo "No changes."
          else
            git commit -m "V10: Agency Content Update [skip ci]"
            git pull --rebase
            git push
          fi
      
      - name: Deploy to Vercel
        run: |
          npm install --global vercel@latest
          rm -rf .git
          cd website
          echo '{"version": 2}' > vercel.json
          mkdir -p .vercel
          echo '{"orgId":"'$VERCEL_ORG_ID'","projectId":"'$VERCEL_PROJECT_ID'"}' > .vercel/project.json
          vercel deploy --prod --token=$VERCEL_TOKEN --yes
