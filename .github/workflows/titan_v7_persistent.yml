name: Titan V9 Persistent Library

on:
  schedule:
    - cron: '0 10 * * *'
  workflow_dispatch:

# Nadajemy uprawnienia do zapisywania zmian w repozytorium (Kluczowe dla Kuli ÅšnieÅ¼nej)
permissions:
  contents: write

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  generate-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg jq
          pip install --upgrade pip
          pip install google-generativeai edge-tts jinja2 requests pillow
      
      - name: Prepare Persistence & Assets
        run: |
          # 1. Tworzymy staÅ‚y folder biblioteki, jeÅ›li nie istnieje
          mkdir -p website
          mkdir -p runtime_assets
          
          # 2. Kopiujemy zasoby do folderu roboczego (Å¼eby Python je widziaÅ‚)
          [ -f "assets/music/Just tap.No app intro podkast sayplay.mp3" ] && cp "assets/music/Just tap.No app intro podkast sayplay.mp3" runtime_assets/
          [ -f "assets/music/Just tap.no app final podkast.mp3" ] && cp "assets/music/Just tap.no app final podkast.mp3" runtime_assets/
          [ -f "assets/brand/sayplay_logo.png" ] && cp "assets/brand/sayplay_logo.png" runtime_assets/
          [ -f "assets/brand/milo&gigi-razem-z-logo-sayplay.png" ] && cp "assets/brand/milo&gigi-razem-z-logo-sayplay.png" runtime_assets/milo-gigi.png
      
      - name: Initialize History
        run: |
          [ ! -f "content_history.json" ] && echo '{"seo_pages":[],"blog_posts":[],"podcasts":[],"last_episode_number":0,"last_updated":null}' > content_history.json
      
      - name: Generate Content (Library Build)
        run: python titan_master_orchestrator_v7_persistent.py
      
      - name: Verify Output (Fixed for V9)
        run: |
          # Teraz sprawdzamy folder 'website', a nie stare nazwy
          SEO=$(find "website/seo" -name '*.html' | wc -l)
          BLOG=$(find "website/blog" -name '*.html' | wc -l)
          PODCAST=$(find "website/podcasts" -name '*.mp3' | wc -l)
          
          echo "ğŸ“Š Current Library Size:"
          echo "SEO Pages: $SEO"
          echo "Blog Posts: $BLOG"
          echo "Podcasts: $PODCAST"
          
          # BÅ‚Ä…d tylko jeÅ›li biblioteka jest pusta (0 plikÃ³w)
          if [ "$SEO" -eq 0 ] && [ "$BLOG" -eq 0 ]; then
            echo "âŒ Error: No content generated."
            exit 1
          fi
      
      - name: Commit to GitHub (The Snowball Effect)
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # 1. Dodajemy folder website (gdzie sÄ… wszystkie pliki HTML/MP3)
          git add website/
          git add content_history.json
          
          # 2. Sprawdzamy czy sÄ… zmiany
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            # 3. Zapisujemy zmiany
            git commit -m "Titan V9: Added new content to library [skip ci]"
            
            # 4. Pobieramy najnowsze zmiany z serwera (Å¼eby uniknÄ…Ä‡ konfliktÃ³w) i wysyÅ‚amy
            git pull --rebase
            git push
          fi
      
      - name: Prepare Deployment
        run: |
          mkdir -p deploy
          # Kopiujemy CAÅÄ„ bibliotekÄ™ do folderu wdraÅ¼ania
          cp -r website/* deploy/
      
      - name: Create Vercel config
        run: |
          cd deploy
          cat > vercel.json << 'EOF'
          {
            "version": 2,
            "routes": [
              {"src": "/", "dest": "/index.html"},
              {"src": "/seo", "dest": "/seo/index.html"},
              {"src": "/seo/", "dest": "/seo/index.html"},
              {"src": "/blog", "dest": "/blog/index.html"},
              {"src": "/blog/", "dest": "/blog/index.html"},
              {"src": "/podcasts", "dest": "/podcasts/index.html"},
              {"src": "/podcasts/", "dest": "/podcasts/index.html"},
              {"src": "/(.*)", "dest": "/$1"}
            ]
          }
          EOF
      
      - name: Deploy to Vercel
        run: |
          npm install --global vercel@latest
          
          # Fix: Usuwamy .git aby Vercel nie sprawdzaÅ‚ autora (Action Bot)
          rm -rf .git
          
          cd deploy
          mkdir -p .vercel
          echo '{"orgId":"'$VERCEL_ORG_ID'","projectId":"'$VERCEL_PROJECT_ID'"}' > .vercel/project.json
          vercel deploy --prod --token=$VERCEL_TOKEN --yes
      
      - name: Success Notification
        if: success()
        run: |
          # Pobieramy statystyki z historii
          TOTAL_SEO=$(jq '.seo_pages | length' content_history.json 2>/dev/null || echo "0")
          TOTAL_BLOG=$(jq '.blog_posts | length' content_history.json 2>/dev/null || echo "0")
          TOTAL_PODCAST=$(jq '.podcasts | length' content_history.json 2>/dev/null || echo "0")
          
          MESSAGE="âœ… TITAN V9 LIBRARY UPDATED!%0A%0AğŸ“š Total in Library:%0AğŸ“„ SEO Pages: ${TOTAL_SEO}%0AğŸ“ Blog Posts: ${TOTAL_BLOG}%0AğŸ™ï¸ Podcasts: ${TOTAL_PODCAST}%0A%0AğŸŒ dashboard.sayplay.co.uk"
          
          [ -n "$TELEGRAM_BOT_TOKEN" ] && curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" -d "chat_id=${TELEGRAM_CHAT_ID}" -d "text=${MESSAGE}" || true
