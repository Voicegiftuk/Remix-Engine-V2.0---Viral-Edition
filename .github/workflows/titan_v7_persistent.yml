name: Titan V7 PERSISTENT

on:
  schedule:
    - cron: '0 10 * * *'
  workflow_dispatch:

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  generate-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          echo "âœ… System dependencies installed"
      
      - name: Install Python packages
        run: |
          pip install --upgrade pip
          pip install google-generativeai edge-tts jinja2 requests pillow
          echo "âœ… Python packages installed"
      
      - name: Verify Python modules
        run: |
          python -c "import google.generativeai; print('âœ… Gemini OK')"
          python -c "import edge_tts; print('âœ… Edge TTS OK')"
          python -c "import jinja2; print('âœ… Jinja2 OK')"
          python -c "import requests; print('âœ… Requests OK')"
      
      - name: Prepare runtime assets
        run: |
          mkdir -p runtime_assets
          echo "ðŸ“ Runtime assets directory created"
          
          if [ -f "assets/music/Just tap.No app intro podkast sayplay.mp3" ]; then
            cp "assets/music/Just tap.No app intro podkast sayplay.mp3" runtime_assets/
            echo "âœ… Intro music copied"
          else
            echo "âš ï¸ Intro music not found"
          fi
          
          if [ -f "assets/music/Just tap.no app final podkast.mp3" ]; then
            cp "assets/music/Just tap.no app final podkast.mp3" runtime_assets/
            echo "âœ… Outro music copied"
          else
            echo "âš ï¸ Outro music not found"
          fi
          
          if [ -f "assets/brand/sayplay_logo.png" ]; then
            cp "assets/brand/sayplay_logo.png" runtime_assets/
            echo "âœ… Logo copied"
          else
            echo "âš ï¸ Logo not found"
          fi
          
          if [ -f "assets/brand/milo&gigi-razem-z-logo-sayplay.png" ]; then
            cp "assets/brand/milo&gigi-razem-z-logo-sayplay.png" runtime_assets/milo-gigi.png
            echo "âœ… Mascots copied"
          else
            echo "âš ï¸ Mascots not found"
          fi
          
          echo ""
          echo "ðŸ“Š Runtime assets summary:"
          ls -lh runtime_assets/ 2>/dev/null || echo "No files copied"
      
      - name: Initialize content history
        run: |
          if [ ! -f "content_history.json" ]; then
            echo '{"seo_pages":[],"blog_posts":[],"podcasts":[],"last_episode_number":0,"last_updated":null}' > content_history.json
            echo "ðŸ“„ Created new content_history.json"
          else
            echo "ðŸ“– Existing content_history.json found"
          fi
      
      - name: Generate content
        run: |
          echo ""
          echo "ðŸš€ Starting TITAN V7 PERSISTENT..."
          echo ""
          python titan_master_orchestrator_v7_persistent.py
        continue-on-error: false
      
      - name: Verify generated output
        run: |
          echo ""
          echo "ðŸ” Verifying generated content..."
          echo ""
          
          LATEST=$(ls -dt TITAN_OUTPUT_V7_* 2>/dev/null | head -1)
          
          if [ -z "$LATEST" ]; then
            echo "âŒ No output directory found!"
            exit 1
          fi
          
          echo "ðŸ“ Latest output: $LATEST"
          
          SEO_COUNT=$(find "$LATEST/web/seo" -name '*.html' -not -name 'index.html' 2>/dev/null | wc -l)
          BLOG_COUNT=$(find "$LATEST/web/blog" -name '*.html' -not -name 'index.html' 2>/dev/null | wc -l)
          PODCAST_COUNT=$(find "$LATEST/web/podcasts" -name '*.mp3' 2>/dev/null | wc -l)
          
          echo "ðŸ“Š Generated: SEO=$SEO_COUNT Blog=$BLOG_COUNT Podcasts=$PODCAST_COUNT"
          
          if [ "$SEO_COUNT" -lt 1 ] || [ "$BLOG_COUNT" -lt 1 ] || [ "$PODCAST_COUNT" -lt 1 ]; then
            echo "âŒ Insufficient content generated"
            exit 1
          fi
          
          if [ ! -f "$LATEST/web/index.html" ]; then
            echo "âŒ Main dashboard missing"
            exit 1
          fi
          
          echo "âœ… All verification checks passed"
      
      - name: Commit metadata
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content_history.json
          git diff --quiet && git diff --staged --quiet || git commit -m "Update content history [skip ci]"
          git push || echo "Nothing to push"
      
      - name: Prepare deployment
        run: |
          LATEST=$(ls -dt TITAN_OUTPUT_V7_* | head -1)
          mkdir -p deploy
          cp -r "$LATEST/web"/* deploy/
          echo "âœ… Deployment package ready"
      
      - name: Deploy to Vercel
        run: |
          npm install --global vercel@latest
          cd deploy
          vercel pull --yes --environment=production --token=$VERCEL_TOKEN
          vercel build --prod --token=$VERCEL_TOKEN
          vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN
          echo "âœ… Deployed to Vercel"
      
      - name: Success notification
        if: success()
        run: |
          LATEST=$(ls -dt TITAN_OUTPUT_V7_* | head -1)
          
          NEW_SEO=$(find "$LATEST/web/seo" -name '*.html' -not -name 'index.html' 2>/dev/null | wc -l)
          NEW_BLOG=$(find "$LATEST/web/blog" -name '*.html' -not -name 'index.html' 2>/dev/null | wc -l)
          NEW_PODCAST=$(find "$LATEST/web/podcasts" -name '*.mp3' 2>/dev/null | wc -l)
          
          python3 -c "
import json
try:
    with open('content_history.json', 'r') as f:
        data = json.load(f)
        total_seo = len(data.get('seo_pages', []))
        total_blog = len(data.get('blog_posts', []))
        total_podcast = len(data.get('podcasts', []))
        last_ep = data.get('last_episode_number', 0)
        print(f'{total_seo},{total_blog},{total_podcast},{last_ep}')
except:
    print('0,0,0,0')
" > stats.txt
          
          read TOTAL_SEO TOTAL_BLOG TOTAL_PODCAST LAST_EP < <(cat stats.txt | tr ',' ' ')
          
          MESSAGE="âœ… TITAN V7 SUCCESS!%0A%0A"
          MESSAGE="${MESSAGE}ðŸ†• New: ${NEW_SEO} SEO, ${NEW_BLOG} Blog, ${NEW_PODCAST} Podcasts%0A"
          MESSAGE="${MESSAGE}ðŸ“Š Total: ${TOTAL_SEO} SEO, ${TOTAL_BLOG} Blog, ${TOTAL_PODCAST} Podcasts%0A"
          MESSAGE="${MESSAGE}ðŸŽ™ï¸ Episode: #${LAST_EP}%0A%0A"
          MESSAGE="${MESSAGE}ðŸ”— dashboard.sayplay.co.uk"
          
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            curl -s -X POST \
              "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${MESSAGE}" || true
          fi
      
      - name: Failure notification
        if: failure()
        run: |
          MESSAGE="âŒ TITAN V7 FAILED!%0A%0ACheck: github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            curl -s -X POST \
              "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${MESSAGE}" || true
          fi
      
      - name: Cleanup
        if: always()
        run: |
          ls -dt TITAN_OUTPUT_V7_* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null || true
          echo "âœ… Cleanup complete"
