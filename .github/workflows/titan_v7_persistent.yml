name: Titan V10 Ultimate Agency

on:
  schedule:
    - cron: '0 10 * * *'
  workflow_dispatch:

permissions:
  contents: write

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  agency-run:
    runs-on: ubuntu-latest
    timeout-minutes: 120 # ZwiÄ™kszony czas na generowanie dÅ‚ugich tekstÃ³w
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Agency Tools
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg jq
          pip install --upgrade pip
          pip install google-generativeai edge-tts jinja2 requests pillow
      
      - name: Setup Agency Workspace
        run: |
          mkdir -p website
          mkdir -p social_media
          mkdir -p runtime_assets
          
          # Copy Assets Safety
          [ -f "assets/music/Just tap.No app intro podkast sayplay.mp3" ] && cp "assets/music/Just tap.No app intro podkast sayplay.mp3" runtime_assets/ || true
          [ -f "assets/music/Just tap.no app final podkast.mp3" ] && cp "assets/music/Just tap.no app final podkast.mp3" runtime_assets/ || true
          [ -f "assets/brand/sayplay_logo.png" ] && cp "assets/brand/sayplay_logo.png" runtime_assets/ || true
          [ -f "assets/brand/milo&gigi-razem-z-logo-sayplay.png" ] && cp "assets/brand/milo&gigi-razem-z-logo-sayplay.png" runtime_assets/milo-gigi.png || true
      
      - name: Load Analytics History
        run: |
          if [ ! -f "analytics_history.json" ]; then
            echo '{"history":[]}' > analytics_history.json
          fi
      
      - name: Start Marketing Engine
        run: python titan_v10_ultimate.py
      
      - name: Save Agency Output (Commit)
        run: |
          git config --local user.email "agency@sayplay.co.uk"
          git config --local user.name "Titan V10 Agency"
          
          # Add Website (Public)
          git add website/
          # Add Social Media Drafts (Internal)
          git add social_media/
          # Add Analytics Data (Memory)
          git add analytics_history.json
          
          if git diff --staged --quiet; then
            echo "No new campaigns created."
          else
            git commit -m "V10 Agency: New Campaigns & Analytics Update [skip ci]"
            git pull --rebase
            git push
          fi
      
      - name: Deploy Website to Vercel
        run: |
          npm install --global vercel@latest
          rm -rf .git
          cd website
          # Auto-create vercel.json if missing
          echo '{"version": 2}' > vercel.json
          mkdir -p .vercel
          echo '{"orgId":"'$VERCEL_ORG_ID'","projectId":"'$VERCEL_PROJECT_ID'"}' > .vercel/project.json
          vercel deploy --prod --token=$VERCEL_TOKEN --yes
      
      - name: Agency Report
        if: success()
        run: |
          CAMPAIGNS=$(ls -1 social_media | wc -l)
          MESSAGE="âœ… TITAN V10 REPORT%0A%0AAgency has completed operations.%0AğŸ“ˆ Campaigns Created: ${CAMPAIGNS}%0AğŸŒ Website Updated%0AğŸ“± Social Assets Ready in GitHub"
          [ -n "$TELEGRAM_BOT_TOKEN" ] && curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" -d "chat_id=${TELEGRAM_CHAT_ID}" -d "text=${MESSAGE}" || true
